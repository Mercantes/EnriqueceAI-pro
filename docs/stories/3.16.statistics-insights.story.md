# Story 3.16: EstatÃ­sticas â€” Insights AvanÃ§ados

## Status

**Ready for Review**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**M (5 points)** â€” 3 seÃ§Ãµes de charts com queries agregadas.

## Risks

- **R1:** Depende de loss_reasons (Story 3.10) para chart de motivos de perda
- **R2:** Tempo de resposta exige cÃ¡lculo complexo de intervalo entre criaÃ§Ã£o e primeira atividade

## Story

**As a** manager,
**I want** uma tela de estatÃ­sticas com insights de motivos de perda, conversÃ£o por origem e tempo de resposta,
**so that** eu possa identificar padrÃµes e melhorar o processo de vendas.

## Scope

**IN:**
- Rota `/statistics` (ou refatorar `/reports`)
- 3 seÃ§Ãµes de charts: Motivos de Perda, ConversÃ£o por Origem, Tempo de Resposta
- Filtros de perÃ­odo e vendedores
- Modal de customizaÃ§Ã£o de intervalo de tempo
- Tabela de tempo de resposta por cadÃªncia

**OUT:**
- RelatÃ³rios exportÃ¡veis em PDF
- Dashboard executivo (C-level)
- ComparaÃ§Ã£o entre perÃ­odos

## Acceptance Criteria

1. Rota `/statistics` acessÃ­vel via top bar (EstatÃ­sticas > Insights)
2. Chart "Motivos de Perda": bar chart horizontal com motivo + % por motivo
3. Chart "ConversÃ£o por Origem": stacked bar chart, verde = convertido, vermelho = perdido, por origem/source
4. SeÃ§Ã£o "Tempo de Resposta": KPI "X% abordados em atÃ© Y" + tabela por cadÃªncia
5. Modal de customizaÃ§Ã£o de intervalo: botÃµes (1 MIN, 5 MIN, 30 MIN, 1H, 3H, 5H) + input custom
6. Tabela por cadÃªncia: nome cadÃªncia | leads abordados | em atÃ© X tempo (count + %)
7. Filtros de perÃ­odo e vendedores funcionais

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Statistics service** (AC: 2, 3, 4, 6)
  - [x] 1.1 Criar `src/features/reports/services/statistics.service.ts`
  - [x] 1.2 Query: motivos de perda com count e % (join loss_reasons + cadence_enrollments)
  - [x] 1.3 Query: conversÃ£o por origem (leads por source, split qualified vs unqualified)
  - [x] 1.4 Query: tempo de resposta (diff entre lead.created_at e primeira interaction, GROUP BY cadence)

- [x] **Task 2: Server Actions** (AC: 7)
  - [x] 2.1 `fetch-statistics.ts` â€” aceitar filtros de perÃ­odo, vendedores, intervalo
  - [x] 2.2 Retornar dados formatados para charts

- [x] **Task 3: Statistics UI** (AC: 1, 2, 3, 4, 5, 6, 7)
  - [x] 3.1 Criar `src/features/reports/components/StatisticsView.tsx`
  - [x] 3.2 `LossReasonsChart.tsx` â€” bar chart horizontal (recharts)
  - [x] 3.3 `ConversionByOriginChart.tsx` â€” stacked bar chart
  - [x] 3.4 `ResponseTimeSection.tsx` â€” KPI + tabela por cadÃªncia
  - [x] 3.5 `TimeIntervalModal.tsx` â€” botÃµes de intervalo + input custom
  - [x] 3.6 Filtros de perÃ­odo e vendedores

- [x] **Task 4: Routing** (AC: 1)
  - [x] 4.1 Criar `src/app/(app)/statistics/page.tsx`
  - [x] 4.2 Integrar na sidebar (EstatÃ­sticas com Ã­cone PieChart, manager only)

- [x] **Task 5: Testes**
  - [x] 5.1 Testes para statistics service queries â€” 8 testes
  - [x] 5.2 Testes para StatisticsView component (render, empty state) â€” 7 testes

## Dev Notes

**Source Tree:**
```
src/features/reports/                   â†’ Estender com statistics
src/features/reports/components/        â†’ ReportsView.tsx existe â€” adicionar StatisticsView
src/app/(app)/reports/page.tsx          â†’ Existe â€” criar /statistics como rota separada
```

**Reports existente:** JÃ¡ tem OverallReport, CadenceReport, SdrReport com period filter e CSV export. A rota `/statistics` Ã© nova e complementar.

**Meetime Reference:** Screenshots 17, 18, 20 â€” Insights com charts e tempo de resposta

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/reports/**/*.test.ts`
- **Rodar:** `pnpm vitest run src/features/reports`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |
| 2026-02-21 | 1.1 | ValidaÃ§Ã£o GO (10/10) â€” status Draft â†’ Ready | @po (Pax) |
| 2026-02-21 | 2.0 | ImplementaÃ§Ã£o completa â€” service, action, 5 UI components, 15 testes (981 total pass) | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- Recharts Tooltip `Formatter` type incompatible with strict TS â€” removed custom formatter, using default Tooltip
- `noUncheckedIndexedAccess` required `!` assertions on sorted array access in tests

### Completion Notes List
- Statistics service: 3 query functions (loss reasons, conversion by origin, response time)
- Server action: `fetch-statistics.ts` with period/user/threshold filters
- StatisticsView: main page with period buttons, user dropdown, 3 chart sections
- LossReasonsChart: horizontal bar chart (recharts) with red bars
- ConversionByOriginChart: stacked bar chart green (converted) / red (lost)
- ResponseTimeSection: KPI card + cadence table with color-coded percentages
- TimeIntervalModal: preset buttons (1MIN-5H) + custom input
- Sidebar: added "EstatÃ­sticas" nav item (PieChart icon, manager only, /statistics)
- 15 tests total (8 service + 7 component)

### File List
- `src/features/reports/services/statistics.service.ts` â€” NEW
- `src/features/reports/services/statistics.service.test.ts` â€” NEW
- `src/features/reports/actions/fetch-statistics.ts` â€” NEW
- `src/features/reports/components/StatisticsView.tsx` â€” NEW
- `src/features/reports/components/StatisticsView.test.tsx` â€” NEW
- `src/features/reports/components/LossReasonsChart.tsx` â€” NEW
- `src/features/reports/components/ConversionByOriginChart.tsx` â€” NEW
- `src/features/reports/components/ResponseTimeSection.tsx` â€” NEW
- `src/features/reports/components/TimeIntervalModal.tsx` â€” NEW
- `src/app/(app)/statistics/page.tsx` â€” NEW
- `src/shared/components/AppSidebar.tsx` â€” MODIFIED (added PieChart icon + EstatÃ­sticas nav item)
