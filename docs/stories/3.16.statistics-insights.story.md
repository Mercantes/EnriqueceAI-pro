# Story 3.16: EstatÃ­sticas â€” Insights AvanÃ§ados

## Status

**Draft**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**M (5 points)** â€” 3 seÃ§Ãµes de charts com queries agregadas.

## Risks

- **R1:** Depende de loss_reasons (Story 3.10) para chart de motivos de perda
- **R2:** Tempo de resposta exige cÃ¡lculo complexo de intervalo entre criaÃ§Ã£o e primeira atividade

## Story

**As a** manager,
**I want** uma tela de estatÃ­sticas com insights de motivos de perda, conversÃ£o por origem e tempo de resposta,
**so that** eu possa identificar padrÃµes e melhorar o processo de vendas.

## Scope

**IN:**
- Rota `/statistics` (ou refatorar `/reports`)
- 3 seÃ§Ãµes de charts: Motivos de Perda, ConversÃ£o por Origem, Tempo de Resposta
- Filtros de perÃ­odo e vendedores
- Modal de customizaÃ§Ã£o de intervalo de tempo
- Tabela de tempo de resposta por cadÃªncia

**OUT:**
- RelatÃ³rios exportÃ¡veis em PDF
- Dashboard executivo (C-level)
- ComparaÃ§Ã£o entre perÃ­odos

## Acceptance Criteria

1. Rota `/statistics` acessÃ­vel via top bar (EstatÃ­sticas > Insights)
2. Chart "Motivos de Perda": bar chart horizontal com motivo + % por motivo
3. Chart "ConversÃ£o por Origem": stacked bar chart, verde = convertido, vermelho = perdido, por origem/source
4. SeÃ§Ã£o "Tempo de Resposta": KPI "X% abordados em atÃ© Y" + tabela por cadÃªncia
5. Modal de customizaÃ§Ã£o de intervalo: botÃµes (1 MIN, 5 MIN, 30 MIN, 1H, 3H, 5H) + input custom
6. Tabela por cadÃªncia: nome cadÃªncia | leads abordados | em atÃ© X tempo (count + %)
7. Filtros de perÃ­odo e vendedores funcionais

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [ ] **Task 1: Statistics service** (AC: 2, 3, 4, 6)
  - [ ] 1.1 Criar `src/features/reports/services/statistics.service.ts`
  - [ ] 1.2 Query: motivos de perda com count e % (join loss_reasons + cadence_enrollments)
  - [ ] 1.3 Query: conversÃ£o por origem (leads por source, split qualified vs unqualified)
  - [ ] 1.4 Query: tempo de resposta (diff entre lead.created_at e primeira interaction, GROUP BY cadence)

- [ ] **Task 2: Server Actions** (AC: 7)
  - [ ] 2.1 `get-statistics-data.ts` â€” aceitar filtros de perÃ­odo, vendedores, intervalo
  - [ ] 2.2 Retornar dados formatados para charts

- [ ] **Task 3: Statistics UI** (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] 3.1 Criar `src/features/reports/components/StatisticsView.tsx`
  - [ ] 3.2 `LossReasonsChart.tsx` â€” bar chart horizontal (recharts)
  - [ ] 3.3 `ConversionByOriginChart.tsx` â€” stacked bar chart
  - [ ] 3.4 `ResponseTimeSection.tsx` â€” KPI + tabela por cadÃªncia
  - [ ] 3.5 `TimeIntervalModal.tsx` â€” botÃµes de intervalo + input custom
  - [ ] 3.6 Filtros de perÃ­odo e vendedores

- [ ] **Task 4: Routing** (AC: 1)
  - [ ] 4.1 Criar `src/app/(app)/statistics/page.tsx`
  - [ ] 4.2 Integrar na top bar (EstatÃ­sticas > Insights)

- [ ] **Task 5: Testes**
  - [ ] 5.1 Testes para statistics service queries
  - [ ] 5.2 Testes para charts components (render, empty state)

## Dev Notes

**Source Tree:**
```
src/features/reports/                   â†’ Estender com statistics
src/features/reports/components/        â†’ ReportsView.tsx existe â€” adicionar StatisticsView
src/app/(app)/reports/page.tsx          â†’ Existe â€” criar /statistics como rota separada
```

**Reports existente:** JÃ¡ tem OverallReport, CadenceReport, SdrReport com period filter e CSV export. A rota `/statistics` Ã© nova e complementar.

**Meetime Reference:** Screenshots 17, 18, 20 â€” Insights com charts e tempo de resposta

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/reports/**/*.test.ts`
- **Rodar:** `pnpm vitest run src/features/reports`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_
