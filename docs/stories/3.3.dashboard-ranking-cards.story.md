# Story 3.3: Dashboard â€” Ranking Cards

## Status

**Done**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**M (5 points)** â€” 3 cards com queries agregadas e breakdown por SDR.

## Risks

- **R1:** Queries de breakdown por SDR podem ser lentas em orgs grandes
- **R2:** CÃ¡lculo de "% do previsto" depende de goals (3.2)

## Story

**As a** manager,
**I want** 3 cards de ranking mostrando leads finalizados, atividades realizadas e taxa de conversÃ£o por SDR,
**so that** eu possa identificar performance individual e do time.

## Scope

**IN:**
- 3 cards de ranking com dados reais
- Breakdown por SDR dentro de cada card
- Indicadores de % previsto vs realizado
- MÃ©dia por vendedor

**OUT:**
- Filtros (implementados em 3.2)
- Insights charts (Story 3.4)
- ExportaÃ§Ã£o de dados

## Acceptance Criteria

1. Card "Leads Finalizados": total, % do previsto, meta mÃªs, breakdown por SDR (prospectando/finalizados), mÃ©dia/vendedor
2. Card "Atividades Realizadas": total, % do previsto, meta mÃªs, breakdown por SDR (mÃ©dia diÃ¡ria), mÃ©dia/vendedor
3. Card "Taxa de ConversÃ£o": percentual, acima/abaixo meta, meta mÃªs, breakdown por SDR, mÃ©dia/vendedor
4. Dados reais do banco (queries agregadas)
5. % do previsto baseado nas metas de goals/goals_per_user
6. Responsivo (stack vertical em mobile)

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Ranking queries service** (AC: 1, 2, 3, 4, 5)
  - [x] 1.1 Criar `src/features/dashboard/services/ranking-metrics.service.ts`
  - [x] 1.2 Query: leads finalizados por SDR no perÃ­odo (enrollment status = 'completed'/'replied')
  - [x] 1.3 Query: atividades realizadas por SDR (interactions count via enrollment lookup)
  - [x] 1.4 Query: taxa de conversÃ£o por SDR (qualified / total leads)
  - [x] 1.5 Comparar com metas de goals (org-level targets)

- [x] **Task 2: Server Action** (AC: 4, 5)
  - [x] 2.1 Criar `src/features/dashboard/actions/get-ranking-data.ts`
  - [x] 2.2 Aceitar filtros de perÃ­odo/cadÃªncia/vendedores do parent dashboard

- [x] **Task 3: Ranking UI** (AC: 1, 2, 3, 6)
  - [x] 3.1 Componente `RankingCard.tsx` â€” reutilizÃ¡vel para os 3 cards
  - [x] 3.2 Props: title, icon, unit, RankingCardData, secondaryLabel
  - [x] 3.3 SDR breakdown: lista com user_id + valor individual
  - [x] 3.4 Integrar no DashboardView (slot ranking-cards)

- [x] **Task 4: Testes** (AC: 4)
  - [x] 4.1 Testes para ranking-metrics.service.ts (8 tests)
  - [x] 4.2 Testes para RankingCard component (10 tests)
  - [x] 4.3 Testes para get-ranking-data action (5 tests)

## Dev Notes

**DependÃªncia:** Story 3.2 deve estar concluÃ­da (tabelas goals e layout dashboard existem).

**Queries base:**
- Leads finalizados: `cadence_enrollments` com status IN ('completed', 'converted') + JOIN org_members
- Atividades: `interactions` COUNT por user_id no perÃ­odo
- ConversÃ£o: leads 'qualified' / total leads por SDR

**Meetime Reference:** Screenshot 1 â€” 3 cards lado a lado abaixo do hero KPI

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/dashboard/**/*.test.ts`
- **Rodar:** `pnpm vitest run src/features/dashboard`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |
| 2026-02-21 | 1.1 | ImplementaÃ§Ã£o completa â€” migration, service, action, UI, testes | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- Typecheck: 0 errors
- Lint: 0 errors, 0 warnings
- Tests: 644 passed, 0 failed (71 test files)
- Dashboard tests: 58 passed (7 test files)
- Build: success

### Completion Notes List
- Added migration to extend goals tables with activities_target and conversion_target columns
- enrollment_status enum has no 'converted' value â€” used 'completed'/'replied' for finished leads
- interactions table has no user_id â€” used cadence_enrollments.enrolled_by to map interactions to SDR
- SDR display uses user_id.slice(0,8) â€” proper user display names will come with profiles table
- Conversion rate card: total is a percentage (0-100), not absolute count
- RankingCard is fully reusable â€” accepts title, icon, unit, data, secondaryLabel
- All 3 ranking queries called in parallel via Promise.all

### File List
| File | Action | Description |
|------|--------|-------------|
| `supabase/migrations/20260221_000005_goals_ranking_targets.sql` | Created | Add activities_target to goals, activities_target + conversion_target to goals_per_user |
| `supabase/rollbacks/20260221_000005_goals_ranking_targets_rollback.sql` | Created | Rollback for ranking targets migration |
| `src/features/dashboard/types/index.ts` | Modified | Added SdrRankingEntry, RankingCardData, RankingData types |
| `src/features/dashboard/services/ranking-metrics.service.ts` | Created | fetchLeadsFinishedRanking, fetchActivitiesRanking, fetchConversionRanking, fetchRankingData |
| `src/features/dashboard/actions/get-ranking-data.ts` | Created | Server action: getRankingData with Zod validation |
| `src/features/dashboard/components/RankingCard.tsx` | Created | Reusable ranking card with SDR breakdown |
| `src/features/dashboard/components/DashboardView.tsx` | Modified | Added ranking prop, renders 3 RankingCards in grid |
| `src/app/(app)/dashboard/page.tsx` | Modified | Calls getRankingData in parallel with getDashboardData |
| `src/features/dashboard/index.ts` | Modified | Added ranking type and component exports |
| `src/features/dashboard/services/ranking-metrics.service.test.ts` | Created | Service tests (8 tests) |
| `src/features/dashboard/actions/get-ranking-data.test.ts` | Created | Action tests (5 tests) |
| `src/features/dashboard/components/RankingCard.test.tsx` | Created | Component tests (10 tests) |
| `src/features/dashboard/components/DashboardView.test.tsx` | Modified | Updated slot tests, added ranking rendering tests (14 tests) |
