# Story 3.4: Dashboard ‚Äî Insights Charts

## Status

**Done**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**M (5 points)** ‚Äî 2 charts com queries agregadas + migration para loss_reason_id.

## Risks

- **R1:** Chart de motivos de perda precisa de dados da tabela loss_reasons (3.10) ‚Äî pode usar seed data
- **R2:** Stacked bar chart precisa de lib de charts robusta

## Story

**As a** manager,
**I want** gr√°ficos de insights mostrando motivos de perda e convers√£o por origem,
**so that** eu possa tomar decis√µes estrat√©gicas baseadas em dados.

## Scope

**IN:**
- Bar chart horizontal de motivos de perda
- Stacked bar chart de convers√£o por origem
- Dados reais do banco
- Migration: coluna `loss_reason_id` em `cadence_enrollments`

**OUT:**
- CRUD de motivos de perda (Story 3.10)
- Relat√≥rios avan√ßados (Wave 4)
- Export de charts

## Acceptance Criteria

1. Bar chart horizontal mostrando motivos de perda com % por motivo
2. Stacked bar chart de convers√£o por origem (verde = convertido, vermelho = perdido)
3. Dados reais via queries agregadas
4. Empty state quando n√£o h√° dados suficientes
5. Responsivo
6. Migration: coluna `loss_reason_id` (UUID, nullable, FK ‚Üí loss_reasons) em `cadence_enrollments`

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Migration** (AC: 6)
  - [x] 1.1 Migration: ADD COLUMN `loss_reason_id` UUID nullable em `cadence_enrollments`
  - [x] 1.2 FK ‚Üí `loss_reasons(id)` ‚Äî criada tabela `loss_reasons` nesta migration
  - [x] 1.3 **Decis√£o:** criar tabela `loss_reasons` nesta migration para satisfazer FK, com RLS policies
  - [x] 1.4 Rollback correspondente

- [x] **Task 2: Insights queries service** (AC: 1, 2, 3)
  - [x] 2.1 Criar `src/features/dashboard/services/insights-metrics.service.ts`
  - [x] 2.2 Query: COUNT enrollments por loss_reason, GROUP BY, com %
  - [x] 2.3 Query: leads por cadence (origin), split convertidos (qualified) vs perdidos (unqualified/archived)

- [x] **Task 3: Server Action** (AC: 3)
  - [x] 3.1 Criar `src/features/dashboard/actions/get-insights-data.ts`
  - [x] 3.2 Aceitar filtros de per√≠odo (month, cadenceIds, userIds)

- [x] **Task 4: Charts UI** (AC: 1, 2, 4, 5)
  - [x] 4.1 Componente `LossReasonsChart.tsx` ‚Äî bar chart horizontal com recharts
  - [x] 4.2 Componente `ConversionByOriginChart.tsx` ‚Äî stacked bar chart
  - [x] 4.3 Empty states para ambos charts
  - [x] 4.4 Integrar no DashboardView (slot reservado em 3.2)

- [x] **Task 5: Testes** (AC: 3)
  - [x] 5.1 Testes para insights-metrics.service.ts (10 tests)
  - [x] 5.2 Testes para componentes de chart (10 tests ‚Äî 5 cada)
  - [x] 5.3 Testes para get-insights-data action (5 tests)
  - [x] 5.4 DashboardView.test.tsx atualizado para insights prop (15 tests total)

## Dev Notes

**Nota de depend√™ncia:** A tabela `loss_reasons` √© formalmente criada na Story 3.10. Por√©m, para a FK funcionar, esta migration pode criar a tabela b√°sica aqui. Coordenar com Story 3.10 para evitar conflito de migration.

**Alternativa:** N√£o criar FK agora, apenas coluna TEXT `loss_reason` ‚Äî mais simples, menos acoplamento. Discutir com @architect.

**Meetime Reference:** Screenshot 1 ‚Äî 2 cards de insights abaixo dos rankings

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/dashboard/**/*.test.ts`
- **Rodar:** `pnpm vitest run src/features/dashboard`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |
| 2026-02-21 | 1.1 | Implementa√ß√£o completa: migration, service, action, charts, 30 testes | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- TS2322: Recharts Tooltip `formatter` type incompatible ‚Äî params `value`/`name` can be `undefined`. Fixed with `as never` cast.

### Completion Notes List
- **Decis√£o origin:** Leads n√£o possuem coluna `source`/`origin`. Usou-se nome da cad√™ncia como "origin" no chart de convers√£o (cada cad√™ncia representa um canal de aquisi√ß√£o).
- **Decis√£o loss_reasons:** Tabela `loss_reasons` criada nesta migration para satisfazer FK. Story 3.10 pode adicionar CRUD sem conflito pois tabela j√° existe.
- **Decis√£o status mapping:** `qualified` = convertido, `unqualified`/`archived` = perdido. Leads com status `new`/`contacted` s√£o ignorados (ainda em andamento).
- 670 testes passando (30 novos nesta story). Build limpo. Lint limpo. Typecheck limpo.

### File List
| File | Action | Description |
|------|--------|-------------|
| `supabase/migrations/20260221_000006_loss_reasons.sql` | Created | Migration: tabela loss_reasons + coluna loss_reason_id em cadence_enrollments |
| `supabase/rollbacks/20260221_000006_loss_reasons_rollback.sql` | Created | Rollback da migration |
| `src/features/dashboard/types/index.ts` | Modified | Adicionados LossReasonEntry, ConversionByOriginEntry, InsightsData |
| `src/features/dashboard/services/insights-metrics.service.ts` | Created | fetchLossReasons, fetchConversionByOrigin, fetchInsightsData |
| `src/features/dashboard/actions/get-insights-data.ts` | Created | Server action com Zod validation |
| `src/features/dashboard/components/LossReasonsChart.tsx` | Created | Bar chart horizontal de motivos de perda |
| `src/features/dashboard/components/ConversionByOriginChart.tsx` | Created | Stacked bar chart de convers√£o por cad√™ncia |
| `src/features/dashboard/components/DashboardView.tsx` | Modified | Adicionada prop insights, renderiza charts condicionalmente |
| `src/app/(app)/dashboard/page.tsx` | Modified | Chama getInsightsData em paralelo |
| `src/features/dashboard/index.ts` | Modified | Barrel exports atualizados |
| `src/features/dashboard/services/insights-metrics.service.test.ts` | Created | 10 testes: loss reasons + conversion by origin + fetchInsightsData |
| `src/features/dashboard/actions/get-insights-data.test.ts` | Created | 5 testes: success, validation, org not found, service error, passthrough |
| `src/features/dashboard/components/LossReasonsChart.test.tsx` | Created | 5 testes: empty state, title, chart, responsive, styling |
| `src/features/dashboard/components/ConversionByOriginChart.test.tsx` | Created | 5 testes: empty state, title, chart, responsive, styling |
| `src/features/dashboard/components/DashboardView.test.tsx` | Modified | Adicionados testes para insights (com/sem prop), BarChart mock |
