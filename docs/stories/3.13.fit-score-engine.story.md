# Story 3.13: Fit Score Engine

## Status

**Draft**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**M (5 points)** — Service de cálculo com batch recalc + trigger on change.

## Risks

- **R1:** Batch recalc pode ser lento em orgs com muitos leads
- **R2:** Trigger de recalc em regras alteradas precisa ser debounced
- **R3:** Operators "contém"/"começa com" precisam de case-insensitive matching

## Story

**As a** manager,
**I want** que leads sejam avaliados automaticamente com Fit Score baseado nas regras configuradas,
**so that** a equipe possa priorizar os leads mais qualificados.

## Scope

**IN:**
- Service de cálculo de Fit Score
- Trigger no create/update de lead
- Batch recalc quando regra é alterada
- Coluna `fit_score` na tabela `leads`

**OUT:**
- UI de exibição do score na lista (Story 3.14)
- Score influenciando ordenação de atividades
- Machine learning / score adaptativo

## Acceptance Criteria (Given/When/Then)

```gherkin
Given que existem 3 regras de Fit Score configuradas para minha org
When um novo lead é criado
Then o fit_score é calculado automaticamente baseado nas 3 regras

Given que um lead tem email "joao@gmail.com" e a regra "email contém gmail → -1"
When o score é calculado
Then o lead perde 1 ponto por essa regra

Given que eu altero uma regra de scoring
When salvo a alteração
Then todos os leads da org são recalculados em batch (background)

Given que um lead tem fit_score calculado
When eu atualizo o campo "cargo" do lead
Then o fit_score é recalculado automaticamente

Given que não há regras configuradas
When um lead é criado
Then o fit_score fica null (não 0)
```

Additional:
- [ ] Migration: coluna `fit_score` (integer, nullable) em `leads`

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [ ] **Task 1: Migration** (AC: fit_score column)
  - [ ] 1.1 ADD COLUMN `fit_score` INTEGER nullable em `leads`
  - [ ] 1.2 INDEX: (org_id, fit_score) para ordenação
  - [ ] 1.3 Rollback

- [ ] **Task 2: Score calculation service** (AC: cálculo por regra)
  - [ ] 2.1 Criar `src/features/leads/services/fit-score.service.ts`
  - [ ] 2.2 `calculateFitScore(lead, rules): number | null`
  - [ ] 2.3 Implementar operadores: contains (case-insensitive), equals, not_empty, starts_with
  - [ ] 2.4 Somar pontos de todas as regras aplicáveis
  - [ ] 2.5 Retornar null se não há regras

- [ ] **Task 3: Trigger on lead create/update** (AC: cálculo automático)
  - [ ] 3.1 Chamar calculateFitScore após create lead
  - [ ] 3.2 Chamar calculateFitScore após update lead (se campos relevantes mudaram)
  - [ ] 3.3 Integrar nos server actions de leads existentes

- [ ] **Task 4: Batch recalc** (AC: recalc ao alterar regras)
  - [ ] 4.1 Criar `src/features/leads/actions/recalc-fit-scores.ts`
  - [ ] 4.2 Buscar todos leads da org + regras atuais
  - [ ] 4.3 Calcular e UPDATE em batch (chunks de 100)
  - [ ] 4.4 Chamar automaticamente quando save-fit-score-rules é executado (Story 3.11)

- [ ] **Task 5: Testes**
  - [ ] 5.1 Testes para calculateFitScore (cada operador, múltiplas regras, sem regras)
  - [ ] 5.2 Testes para recalc batch action
  - [ ] 5.3 Testes para trigger on create/update

## Dev Notes

**Dependência:** Story 3.11 (tabela `fit_score_rules` + CRUD de regras)

**Implementação dos operadores:**
```typescript
function matchRule(value: string | null, operator: string, ruleValue: string | null): boolean {
  if (!value && operator !== 'not_empty') return false;
  switch (operator) {
    case 'contains': return value!.toLowerCase().includes(ruleValue!.toLowerCase());
    case 'equals': return value!.toLowerCase() === ruleValue!.toLowerCase();
    case 'not_empty': return !!value && value.trim().length > 0;
    case 'starts_with': return value!.toLowerCase().startsWith(ruleValue!.toLowerCase());
    default: return false;
  }
}
```

**Performance:** Para batch recalc em orgs grandes (>10k leads), considerar usar Supabase Edge Function ou processar em chunks com delay.

**Meetime Reference:** Screenshots 13, 14

### Testing

- **Framework:** Vitest
- **Location:** `src/features/leads/services/fit-score.service.test.ts`
- **Rodar:** `pnpm vitest run src/features/leads`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_
