# Story 3.13: Fit Score Engine

## Status

**Done**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**M (5 points)** — Service de cálculo com batch recalc + trigger on change.

## Risks

- **R1:** Batch recalc pode ser lento em orgs com muitos leads
- **R2:** Trigger de recalc em regras alteradas precisa ser debounced
- **R3:** Operators "contém"/"começa com" precisam de case-insensitive matching

## Story

**As a** manager,
**I want** que leads sejam avaliados automaticamente com Fit Score baseado nas regras configuradas,
**so that** a equipe possa priorizar os leads mais qualificados.

## Scope

**IN:**
- Service de cálculo de Fit Score
- Trigger no create/update de lead
- Batch recalc quando regra é alterada
- Coluna `fit_score` na tabela `leads`

**OUT:**
- UI de exibição do score na lista (Story 3.14)
- Score influenciando ordenação de atividades
- Machine learning / score adaptativo

## Acceptance Criteria (Given/When/Then)

```gherkin
Given que existem 3 regras de Fit Score configuradas para minha org
When um novo lead é criado
Then o fit_score é calculado automaticamente baseado nas 3 regras

Given que um lead tem email "joao@gmail.com" e a regra "email contém gmail → -1"
When o score é calculado
Then o lead perde 1 ponto por essa regra

Given que eu altero uma regra de scoring
When salvo a alteração
Then todos os leads da org são recalculados em batch (background)

Given que um lead tem fit_score calculado
When eu atualizo o campo "cargo" do lead
Then o fit_score é recalculado automaticamente

Given que não há regras configuradas
When um lead é criado
Then o fit_score fica null (não 0)
```

Additional:
- [x] Migration: coluna `fit_score` (integer, nullable) em `leads`

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Migration** (AC: fit_score column)
  - [x] 1.1 ADD COLUMN `fit_score` INTEGER nullable em `leads`
  - [x] 1.2 INDEX: (org_id, fit_score) para ordenação
  - [x] 1.3 Rollback

- [x] **Task 2: Score calculation service** (AC: cálculo por regra)
  - [x] 2.1 Criar `src/features/leads/services/fit-score.service.ts`
  - [x] 2.2 `calculateFitScore(lead, rules): number | null`
  - [x] 2.3 Implementar operadores: contains (case-insensitive), equals, not_empty, starts_with
  - [x] 2.4 Somar pontos de todas as regras aplicáveis
  - [x] 2.5 Retornar null se não há regras

- [x] **Task 3: Trigger on lead create/update** (AC: cálculo automático)
  - [x] 3.1 Chamar calculateFitScore após create lead
  - [x] 3.2 Chamar calculateFitScore após update lead (se campos relevantes mudaram)
  - [x] 3.3 Integrar nos server actions de leads existentes

- [x] **Task 4: Batch recalc** (AC: recalc ao alterar regras)
  - [x] 4.1 Criar `src/features/leads/actions/recalc-fit-scores.ts`
  - [x] 4.2 Buscar todos leads da org + regras atuais
  - [x] 4.3 Calcular e UPDATE em batch (chunks de 100)
  - [x] 4.4 Chamar automaticamente quando save-fit-score-rules é executado (Story 3.11)

- [x] **Task 5: Testes**
  - [x] 5.1 Testes para calculateFitScore (cada operador, múltiplas regras, sem regras)
  - [x] 5.2 Testes para recalc batch action
  - [x] 5.3 Testes para trigger on create/update

## Dev Notes

**Dependência:** Story 3.11 (tabela `fit_score_rules` + CRUD de regras)

**Implementação dos operadores:**
```typescript
function matchRule(value: string | null, operator: string, ruleValue: string | null): boolean {
  if (!value && operator !== 'not_empty') return false;
  switch (operator) {
    case 'contains': return value!.toLowerCase().includes(ruleValue!.toLowerCase());
    case 'equals': return value!.toLowerCase() === ruleValue!.toLowerCase();
    case 'not_empty': return !!value && value.trim().length > 0;
    case 'starts_with': return value!.toLowerCase().startsWith(ruleValue!.toLowerCase());
    default: return false;
  }
}
```

**Performance:** Para batch recalc em orgs grandes (>10k leads), considerar usar Supabase Edge Function ou processar em chunks com delay.

**Meetime Reference:** Screenshots 13, 14

### Testing

- **Framework:** Vitest
- **Location:** `src/features/leads/services/fit-score.service.test.ts`
- **Rodar:** `pnpm vitest run src/features/leads`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |
| 2026-02-21 | 1.1 | Validação GO (10/10) — status Draft → Ready | @po (Pax) |
| 2026-02-21 | 1.2 | Implementação completa — 5 tasks, 20 novos testes, status Ready → Done | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- Pure function `calculateFitScore` — no DB access, testable in isolation
- Batch recalc processes leads in chunks of 100 to avoid DB overload
- Trigger in `update-lead.ts` is fire-and-forget (`.catch(() => {})`) — doesn't block response
- Trigger in `save-fit-score-rules.ts` fires `recalcFitScoresForOrg` as fire-and-forget after rules saved
- UF field extracted from `endereco` JSONB column for fit score evaluation

### Completion Notes List
- Migration `20260221_000013_fit_score_column.sql` — nullable INTEGER column + composite index
- `fit-score.service.ts` — pure function with 4 operators (contains, equals, not_empty, starts_with), all case-insensitive
- `recalc-fit-scores.ts` — `recalcFitScoreForLead` (single) + `recalcFitScoresForOrg` (batch with chunks)
- `update-lead.ts` — trigger recalc when relevant fields change (fire-and-forget)
- `save-fit-score-rules.ts` — trigger batch recalc when rules are saved (fire-and-forget)
- 16 service tests + 4 recalc tests = 20 new tests

### File List
| File | Status |
|------|--------|
| `supabase/migrations/20260221_000013_fit_score_column.sql` | NEW |
| `src/features/leads/services/fit-score.service.ts` | NEW |
| `src/features/leads/services/fit-score.service.test.ts` | NEW |
| `src/features/leads/actions/recalc-fit-scores.ts` | NEW |
| `src/features/leads/actions/recalc-fit-scores.test.ts` | NEW |
| `src/features/leads/actions/update-lead.ts` | MODIFIED (fit score trigger) |
| `src/features/settings-prospecting/actions/save-fit-score-rules.ts` | MODIFIED (batch recalc trigger) |
