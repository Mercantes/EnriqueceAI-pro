# Story 2.3: WhatsApp Business Messaging

## Status

**Ready**

## Complexity Estimate

**L (Large)** — Meta Cloud API integration com webhook bidirecional.

## Risks

- **R1:** WhatsApp requer templates pré-aprovados para mensagens fora da janela de 24h
- **R2:** Webhook de incoming messages requer URL pública (precisa deploy)
- **R3:** Créditos de WhatsApp precisam ser controlados por organização

## Story

**As a** sales team,
**I want** to send WhatsApp messages to leads via cadences,
**so that** we can reach prospects no canal de comunicação mais popular do Brasil.

## Acceptance Criteria

1. Envio de mensagens WhatsApp via Meta Cloud API
2. Suporte a mensagens de texto e template messages
3. Webhook para receber delivery status (sent, delivered, read, failed)
4. Webhook para receber incoming messages (replies)
5. Reply detection — marcar enrollment como 'replied'
6. Controle de créditos WhatsApp por organização
7. Validação de número brasileiro (+55)
8. Rate limiting (80 msgs/sec max)
9. Registro de interactions no banco
10. Testes unitários

## Tasks / Subtasks

- [ ] **Task 1: WhatsApp Send Service**
  - [ ] 1.1 Completar `src/features/integrations/services/whatsapp.service.ts`
  - [ ] 1.2 Método `sendMessage({ orgId, to, body, templateName? })`
  - [ ] 1.3 Meta Cloud API client (`graph.facebook.com/v18.0/`)
  - [ ] 1.4 Token fetch de `whatsapp_connections`
  - [ ] 1.5 Validação de número (+55, formato brasileiro)

- [ ] **Task 2: Credit control**
  - [ ] 2.1 Verificar créditos antes de enviar (`whatsapp_credits` table)
  - [ ] 2.2 Decrementar `used_credits` após envio
  - [ ] 2.3 Se excedeu: incrementar `overage_count`, permitir envio

- [ ] **Task 3: Webhook handler**
  - [ ] 3.1 Criar `src/app/api/webhooks/whatsapp/route.ts`
  - [ ] 3.2 Verificação de assinatura Meta (X-Hub-Signature-256)
  - [ ] 3.3 GET handler para webhook verification challenge
  - [ ] 3.4 Processar delivery status → atualizar interaction
  - [ ] 3.5 Processar incoming messages → marcar enrollment 'replied'

- [ ] **Task 4: Integrar com cadence execution**
  - [ ] 4.1 Substituir stub de WhatsApp na Edge Function
  - [ ] 4.2 Buscar `whatsapp_connection` da org

- [ ] **Task 5: Testes**
  - [ ] 5.1 Testes unitários para WhatsApp service (mock Meta API)
  - [ ] 5.2 Testes para webhook handler
  - [ ] 5.3 Testes para credit control

## Dev Notes

### Tabela whatsapp_connections (já existe)
```sql
CREATE TABLE whatsapp_connections (
  id UUID, org_id UUID, phone_number_id TEXT,
  business_account_id TEXT, access_token_encrypted TEXT,
  status connection_status
);
```

### WhatsApp service (já existe parcial)
`src/features/integrations/services/whatsapp.service.ts`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.0 | Story criada para WhatsApp messaging | Claude (Dev) |
