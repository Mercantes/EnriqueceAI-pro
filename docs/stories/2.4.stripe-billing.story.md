# Story 2.4: Stripe Billing Integration

## Status

**Ready**

## Complexity Estimate

**L (Large)** — Stripe Checkout, Customer Portal, webhooks, subscription lifecycle.

## Risks

- **R1:** Stripe webhooks precisam de URL pública (precisa deploy ou Stripe CLI para local)
- **R2:** Subscription lifecycle é complexo (trial → active → past_due → canceled)
- **R3:** Per-seat pricing requer lógica de overage

## Story

**As a** organization manager,
**I want** to upgrade my plan and manage billing,
**so that** my team can access premium features.

## Acceptance Criteria

1. Stripe Checkout para upgrade de plano
2. Stripe Customer Portal para gerenciar assinatura
3. Webhook handler para eventos de subscription
4. Trial → Active transition automática
5. Downgrade/cancel com período de graça
6. Per-seat overage billing (usuários além do incluído)
7. Página de billing atualizada com dados reais do Stripe
8. Invoice history acessível ao manager
9. Alerta de pagamento falho
10. Testes unitários

## Tasks / Subtasks

- [ ] **Task 1: Setup Stripe**
  - [ ] 1.1 `pnpm add stripe`
  - [ ] 1.2 Configurar produtos/preços no Stripe Dashboard
  - [ ] 1.3 Criar `src/lib/stripe/stripe-client.ts`
  - [ ] 1.4 Adicionar `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET` ao .env

- [ ] **Task 2: Checkout e Customer Portal**
  - [ ] 2.1 Server Action `createCheckoutSession(planSlug)`
  - [ ] 2.2 Server Action `createPortalSession()`
  - [ ] 2.3 Callback routes para success/cancel

- [ ] **Task 3: Webhook handler**
  - [ ] 3.1 Criar `src/app/api/webhooks/stripe/route.ts`
  - [ ] 3.2 Validação de assinatura Stripe
  - [ ] 3.3 Processar: subscription.created, .updated, .deleted
  - [ ] 3.4 Processar: invoice.paid, invoice.payment_failed
  - [ ] 3.5 Atualizar `subscriptions` table

- [ ] **Task 4: Atualizar BillingView**
  - [ ] 4.1 Mostrar plano atual com dados reais
  - [ ] 4.2 Botão upgrade → Stripe Checkout
  - [ ] 4.3 Botão manage → Stripe Customer Portal
  - [ ] 4.4 Invoice history

- [ ] **Task 5: Testes**
  - [ ] 5.1 Testes unitários para Stripe service
  - [ ] 5.2 Testes para webhook handler

## Dev Notes

### Billing UI (já existe parcial)
`src/features/billing/components/BillingView.tsx`
`src/features/billing/components/PlanComparison.tsx`

### Planos seed (já existem no banco)
Starter R$149, Pro R$349, Enterprise R$699

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.0 | Story criada para Stripe billing | Claude (Dev) |
