# Story 3.8: Execu√ß√£o de Atividades ‚Äî Tela Principal

## Status

**Draft**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**XL (8 points)** ‚Äî Refazer tela de execu√ß√£o com m√∫ltiplas se√ß√µes e nova tabela.

## Risks

- **R1:** Tela de execu√ß√£o existente (ActivityQueueView) √© completamente substitu√≠da
- **R2:** "Modo Execu√ß√£o r√°pida" √© um agrupamento alternativo que precisa de state management
- **R3:** "Leads Aguardando Primeira Liga√ß√£o" √© conceito novo que precisa de query espec√≠fica

## Story

**As a** SDR,
**I want** uma tela de execu√ß√£o com progresso do dia, objetivo di√°rio, toggle de modo r√°pido e lista de atividades com filtros,
**so that** eu possa executar atividades de forma organizada e acompanhar meu progresso di√°rio.

## Scope

**IN:**
- Card "Meu Progresso Hoje" (finalizado/pendente)
- Card "Objetivo Di√°rio" com meta
- Tab Execu√ß√£o funcional
- Toggle "Modo Execu√ß√£o r√°pida"
- Se√ß√£o "Leads Aguardando Primeira Liga√ß√£o"
- Lista de atividades com filtros e bot√£o Executar
- Indicador de tempo desde √∫ltima atividade
- Migration: tabela `daily_activity_goals`

**OUT:**
- Tab Power Dialer (Story 3.17 ‚Äî placeholder "Em breve")
- Modal de execu√ß√£o split view (Story 3.9)
- VoIP/click-to-call real
- Envio de email/WhatsApp (usa sistema existente)

## Acceptance Criteria

1. Card "Meu Progresso Hoje": "X / Y ATIVIDADES" com indicador verde (finalizado) e cinza (pendente)
2. Card "Objetivo Di√°rio": √≠cone trof√©u, "Objetivo di√°rio (N)", texto motivacional, link "Iniciar novas prospec√ß√µes"
3. Tab "Execu√ß√£o" funcional, tab "Power Dialer" como placeholder "Em breve"
4. Toggle "Modo Execu√ß√£o r√°pida" agrupa atividades por tipo (todos emails juntos, todas liga√ß√µes juntas)
5. Se√ß√£o "Leads Aguardando Primeira Liga√ß√£o" com cards horizontais (checkbox + avatar + nome + badge tempo)
6. Lista de atividades com filtros: Status, Atividade, Cad√™ncia, Passo, Lista de Importa√ß√£o + busca
7. Indicador de tempo desde √∫ltima atividade em vermelho se > 1h ("H√Å 19 HORAS")
8. Bot√£o "Executar" por atividade (abre modal da Story 3.9 quando dispon√≠vel)
9. Migration: tabela `daily_activity_goals` com RLS

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [ ] **Task 1: Migration** (AC: 9)
  - [ ] 1.1 Tabela `daily_activity_goals`: id, org_id, user_id (nullable = org default), target (int), created_at, updated_at
  - [ ] 1.2 RLS: `user_org_id() = org_id`
  - [ ] 1.3 Unique: (org_id, user_id) ‚Äî um goal por user (ou null = default org)
  - [ ] 1.4 Rollback

- [ ] **Task 2: Progress service** (AC: 1, 2)
  - [ ] 2.1 Service: contar atividades do dia (pendente vs conclu√≠da) por user
  - [ ] 2.2 Service: buscar objetivo di√°rio (user-specific ou org default)

- [ ] **Task 3: Leads aguardando** (AC: 5)
  - [ ] 3.1 Query: leads em cad√™ncia com pr√≥ximo step = liga√ß√£o, sem intera√ß√£o de liga√ß√£o
  - [ ] 3.2 Componente `PendingCallLeadCard.tsx` (avatar, nome, badge tempo)
  - [ ] 3.3 Selecionar Todos

- [ ] **Task 4: Activity list refactor** (AC: 6, 7, 8)
  - [ ] 4.1 Componente de filtros expandido (Status, Atividade, Cad√™ncia, Passo, Importa√ß√£o, busca)
  - [ ] 4.2 Coluna tempo desde √∫ltima atividade (formatRelativeTime, vermelho se > 1h)
  - [ ] 4.3 Bot√£o "Executar" por atividade

- [ ] **Task 5: Modo execu√ß√£o r√°pida** (AC: 4)
  - [ ] 5.1 Toggle state no componente
  - [ ] 5.2 Quando ativo: agrupar atividades por tipo (email, phone, whatsapp, etc.)
  - [ ] 5.3 Se√ß√µes colaps√°veis por tipo

- [ ] **Task 6: Main view** (AC: 1, 2, 3)
  - [ ] 6.1 Refazer `ActivityQueueView.tsx` com novo layout
  - [ ] 6.2 Cards de progresso e objetivo no topo
  - [ ] 6.3 Tabs Execu√ß√£o / Power Dialer (placeholder)
  - [ ] 6.4 Integrar se√ß√µes

- [ ] **Task 7: Testes**
  - [ ] 7.1 Testes para progress service
  - [ ] 7.2 Testes para filtros
  - [ ] 7.3 Testes para modo execu√ß√£o r√°pida
  - [ ] 7.4 Testes para tempo relativo

## Dev Notes

**Source Tree:**
```
src/features/activities/components/ActivityQueueView.tsx ‚Üí REFAZER
src/features/activities/components/ActivityRow.tsx        ‚Üí Adaptar
src/features/activities/actions/                          ‚Üí Adicionar filtros
src/features/activities/services/                         ‚Üí Novo progress service
```

**Atividades existentes:** O Flux j√° tem `ActivityQueueView`, `ActivityExecutionSheet` (split panel), `ActivityRow`, `ActivityEmailCompose`, `ActivityWhatsAppCompose`. O foco √© refazer o QueueView mantendo o ExecutionSheet para Story 3.9.

**PendingActivity type atual:** enrollmentId, cadenceId, cadenceName, stepId, stepOrder, totalSteps, channel, templateId, templateSubject, templateBody, aiPersonalization, nextStepDue, lead

**Meetime Reference:** Screenshots 6, 7, 8 ‚Äî Tela de execu√ß√£o com progresso, objetivo, leads aguardando, lista

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/activities/**/*.test.ts`
- **Rodar:** `pnpm vitest run src/features/activities`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_
