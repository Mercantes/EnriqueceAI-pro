# Story 3.8: ExecuÃ§Ã£o de Atividades â€” Tela Principal

## Status

**Done**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**XL (8 points)** â€” Refazer tela de execuÃ§Ã£o com mÃºltiplas seÃ§Ãµes e nova tabela.

## Risks

- **R1:** Tela de execuÃ§Ã£o existente (ActivityQueueView) Ã© completamente substituÃ­da
- **R2:** "Modo ExecuÃ§Ã£o rÃ¡pida" Ã© um agrupamento alternativo que precisa de state management
- **R3:** "Leads Aguardando Primeira LigaÃ§Ã£o" Ã© conceito novo que precisa de query especÃ­fica

## Story

**As a** SDR,
**I want** uma tela de execuÃ§Ã£o com progresso do dia, objetivo diÃ¡rio, toggle de modo rÃ¡pido e lista de atividades com filtros,
**so that** eu possa executar atividades de forma organizada e acompanhar meu progresso diÃ¡rio.

## Scope

**IN:**
- Card "Meu Progresso Hoje" (finalizado/pendente)
- Card "Objetivo DiÃ¡rio" com meta
- Tab ExecuÃ§Ã£o funcional
- Toggle "Modo ExecuÃ§Ã£o rÃ¡pida"
- SeÃ§Ã£o "Leads Aguardando Primeira LigaÃ§Ã£o"
- Lista de atividades com filtros e botÃ£o Executar
- Indicador de tempo desde Ãºltima atividade
- Migration: tabela `daily_activity_goals`

**OUT:**
- Tab Power Dialer (Story 3.17 â€” placeholder "Em breve")
- Modal de execuÃ§Ã£o split view (Story 3.9)
- VoIP/click-to-call real
- Envio de email/WhatsApp (usa sistema existente)

## Acceptance Criteria

1. Card "Meu Progresso Hoje": "X / Y ATIVIDADES" com indicador verde (finalizado) e cinza (pendente)
2. Card "Objetivo DiÃ¡rio": Ã­cone trofÃ©u, "Objetivo diÃ¡rio (N)", texto motivacional, link "Iniciar novas prospecÃ§Ãµes"
3. Tab "ExecuÃ§Ã£o" funcional, tab "Power Dialer" como placeholder "Em breve"
4. Toggle "Modo ExecuÃ§Ã£o rÃ¡pida" agrupa atividades por tipo (todos emails juntos, todas ligaÃ§Ãµes juntas)
5. SeÃ§Ã£o "Leads Aguardando Primeira LigaÃ§Ã£o" com cards horizontais (checkbox + avatar + nome + badge tempo)
6. Lista de atividades com filtros: Status, Atividade, CadÃªncia, Passo, Lista de ImportaÃ§Ã£o + busca
7. Indicador de tempo desde Ãºltima atividade em vermelho se > 1h ("HÃ 19 HORAS")
8. BotÃ£o "Executar" por atividade (abre modal da Story 3.9 quando disponÃ­vel)
9. Migration: tabela `daily_activity_goals` com RLS

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Migration** (AC: 9)
  - [x] 1.1 Tabela `daily_activity_goals`: id, org_id, user_id (nullable = org default), target (int), created_at, updated_at
  - [x] 1.2 RLS: `user_org_id() = org_id`
  - [x] 1.3 Unique: (org_id, user_id) â€” um goal por user (ou null = default org)
  - [x] 1.4 Rollback

- [x] **Task 2: Progress service** (AC: 1, 2)
  - [x] 2.1 Service: contar atividades do dia (pendente vs concluÃ­da) por user
  - [x] 2.2 Service: buscar objetivo diÃ¡rio (user-specific ou org default)

- [x] **Task 3: Leads aguardando** (AC: 5)
  - [x] 3.1 Query: leads em cadÃªncia com prÃ³ximo step = ligaÃ§Ã£o, sem interaÃ§Ã£o de ligaÃ§Ã£o
  - [x] 3.2 Componente `PendingCallLeadCard.tsx` (avatar, nome, badge tempo)
  - [x] 3.3 Selecionar Todos

- [x] **Task 4: Activity list refactor** (AC: 6, 7, 8)
  - [x] 4.1 Componente de filtros expandido (Status, Atividade, CadÃªncia, Passo, ImportaÃ§Ã£o, busca)
  - [x] 4.2 Coluna tempo desde Ãºltima atividade (formatRelativeTime, vermelho se > 1h)
  - [x] 4.3 BotÃ£o "Executar" por atividade

- [x] **Task 5: Modo execuÃ§Ã£o rÃ¡pida** (AC: 4)
  - [x] 5.1 Toggle state no componente
  - [x] 5.2 Quando ativo: agrupar atividades por tipo (email, phone, whatsapp, etc.)
  - [x] 5.3 SeÃ§Ãµes colapsÃ¡veis por tipo

- [x] **Task 6: Main view** (AC: 1, 2, 3)
  - [x] 6.1 Refazer `ActivityQueueView.tsx` com novo layout
  - [x] 6.2 Cards de progresso e objetivo no topo
  - [x] 6.3 Tabs ExecuÃ§Ã£o / Power Dialer (placeholder)
  - [x] 6.4 Integrar seÃ§Ãµes

- [x] **Task 7: Testes**
  - [x] 7.1 Testes para progress service
  - [x] 7.2 Testes para filtros
  - [x] 7.3 Testes para modo execuÃ§Ã£o rÃ¡pida
  - [x] 7.4 Testes para tempo relativo

## Dev Notes

**Source Tree:**
```
src/features/activities/components/ActivityQueueView.tsx â†’ REFAZER
src/features/activities/components/ActivityRow.tsx        â†’ Adaptar
src/features/activities/actions/                          â†’ Adicionar filtros
src/features/activities/services/                         â†’ Novo progress service
```

**Atividades existentes:** O Flux jÃ¡ tem `ActivityQueueView`, `ActivityExecutionSheet` (split panel), `ActivityRow`, `ActivityEmailCompose`, `ActivityWhatsAppCompose`. O foco Ã© refazer o QueueView mantendo o ExecutionSheet para Story 3.9.

**PendingActivity type atual:** enrollmentId, cadenceId, cadenceName, stepId, stepOrder, totalSteps, channel, templateId, templateSubject, templateBody, aiPersonalization, nextStepDue, lead

**Meetime Reference:** Screenshots 6, 7, 8 â€” Tela de execuÃ§Ã£o com progresso, objetivo, leads aguardando, lista

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/activities/**/*.test.ts`
- **Rodar:** `pnpm vitest run src/features/activities`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |
| 2026-02-21 | 1.1 | ValidaÃ§Ã£o GO (10/10) â€” status Draft â†’ Ready | @po (Pax) |
| 2026-02-21 | 1.2 | ImplementaÃ§Ã£o completa â€” 7 tasks, 25 novos testes, status Ready â†’ Done | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- TypeScript error: `daily_activity_goals` table not in generated Supabase types â€” solved with `as never` cast on table name argument
- ActivityQueueView test: `ActivityLead` interface required all fields (org_id, telefone, municipio, uf, porte) â€” fixed baseLead mock

### Completion Notes List
- Migration `20260221_000009_daily_activity_goals.sql` created with table, RLS, unique index, trigger
- `fetchDailyProgress` server action with userâ†’orgâ†’default goal fallback (default 20)
- `fetchPendingCalls` server action filters enrollments by phone channel step
- `ProgressCard` and `DailyGoalCard` components for daily stats
- `PendingCallLeadCard` and `PendingCallsSection` with horizontal scroll + select all
- `ActivityFilters` with Status/Channel/Cadence/Step/Search filters
- `ActivityRow` updated with 5 channel icons and 1h urgency threshold (AC 7)
- `ActivityQueueView` completely rewritten: progress cards, tabs, filters, quick mode grouped by channel
- Page updated to fetch progress + calls in parallel with Promise.all
- 25 new tests across 3 new test files (progress, calls, filters/grouping/time)

### File List
| File | Status |
|------|--------|
| `supabase/migrations/20260221_000009_daily_activity_goals.sql` | NEW |
| `src/features/activities/actions/fetch-daily-progress.ts` | NEW |
| `src/features/activities/actions/fetch-daily-progress.test.ts` | NEW |
| `src/features/activities/actions/fetch-pending-calls.ts` | NEW |
| `src/features/activities/actions/fetch-pending-calls.test.ts` | NEW |
| `src/features/activities/components/ProgressCard.tsx` | NEW |
| `src/features/activities/components/DailyGoalCard.tsx` | NEW |
| `src/features/activities/components/PendingCallLeadCard.tsx` | NEW |
| `src/features/activities/components/PendingCallsSection.tsx` | NEW |
| `src/features/activities/components/ActivityFilters.tsx` | NEW |
| `src/features/activities/components/ActivityRow.tsx` | MODIFIED |
| `src/features/activities/components/ActivityRow.test.ts` | NEW |
| `src/features/activities/components/ActivityQueueView.tsx` | MODIFIED (rewrite) |
| `src/features/activities/components/ActivityQueueView.test.ts` | NEW |
| `src/app/(app)/atividades/page.tsx` | MODIFIED |
