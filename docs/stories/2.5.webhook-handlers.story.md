# Story 2.5: Unified Webhook Infrastructure

## Status

**Ready**

## Complexity Estimate

**M (Medium)** — Framework de webhooks com validação, idempotência, e logging.

## Risks

- **R1:** Cada provider tem formato diferente de assinatura
- **R2:** Webhooks precisam responder < 200ms para evitar retry storms

## Story

**As a** system,
**I want** a robust webhook infrastructure,
**so that** external events are processed reliably and consistently.

## Acceptance Criteria

1. Framework base de webhook com validação de assinatura
2. Idempotência via event_id (eventos duplicados ignorados)
3. Resposta rápida (< 200ms) — processamento pesado em background
4. Logging estruturado para cada evento
5. Dead letter queue para eventos que falharam 3x
6. Testes unitários

## Tasks / Subtasks

- [ ] **Task 1: Webhook utilities**
  - [ ] 1.1 `src/lib/webhooks/verify-signature.ts` — HMAC-SHA256
  - [ ] 1.2 `src/lib/webhooks/idempotency.ts` — check event_id
  - [ ] 1.3 `src/lib/webhooks/logger.ts` — structured logging

- [ ] **Task 2: Consolidar handlers**
  - [ ] 2.1 Email webhooks (de Story 2.2)
  - [ ] 2.2 WhatsApp webhooks (de Story 2.3)
  - [ ] 2.3 Stripe webhooks (de Story 2.4)

- [ ] **Task 3: Testes**
  - [ ] 3.1 Testes para validação de assinatura
  - [ ] 3.2 Testes de idempotência

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.0 | Story criada para webhook infrastructure | Claude (Dev) |
