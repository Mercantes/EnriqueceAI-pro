# Story 3.15: Liga√ß√µes ‚Äî Lista e Detalhes

## Status

**InProgress**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**XL (8 points)** ‚Äî Nova feature module completa com migrations, CRUD, UI complexa.

## Risks

- **R1:** M√≥dulo de liga√ß√µes sem integra√ß√£o VoIP real pode parecer incompleto
- **R2:** Player de √°udio placeholder precisa de UX clara indicando "integra√ß√£o futura"
- **R3:** Tabela calls com muitas colunas ‚Äî migration precisa de review

## Story

**As a** SDR ou manager,
**I want** um m√≥dulo de liga√ß√µes com lista filtr√°vel, status por tipo e modal de detalhes com feedback,
**so that** eu possa registrar e acompanhar todas as liga√ß√µes da equipe.

## Scope

**IN:**
- Nova feature module `src/features/calls/`
- Rota `/calls` com lista de liga√ß√µes
- Filtros: per√≠odo, status, usu√°rio, busca, favoritas
- Status classific√°veis por tipo
- Modal de detalhes com metadados e feedback
- Player de √°udio placeholder
- Exportar CSV
- Migrations: tabelas `calls`, `call_feedback`

**OUT:**
- Integra√ß√£o VoIP real (Twilio/Vonage) ‚Äî epic separado
- Grava√ß√£o de √°udio real
- Click-to-call funcional
- Power Dialer engine

## Acceptance Criteria

1. Rota `/calls` com lista de liga√ß√µes e navega√ß√£o via top bar (Liga√ß√µes > Lista)
2. Filtros: busca, usu√°rio, per√≠odo (Hoje, Esta Semana, Este M√™s, Custom range), toggle favoritas, toggle Todas/Importantes
3. Status icons por tipo: Significativa (verde ‚Üë), N√£o Significativa (cinza ‚Üì), Sem contato (amarelo), Cliente Ocupado (laranja), N√£o Conectada (vermelho)
4. Tabela: Status | Origem | Destino | Data | Dura√ß√£o | Op√ß√µes (view icon)
5. Modal de detalhes: player de √°udio placeholder, metadados (status badge, origem, destino, data, dura√ß√£o, tipo, custo), anota√ß√µes
6. Se√ß√£o FEEDBACK no modal: rich text editor com avatar do autor
7. Status classific√°vel via dropdown no modal
8. Exportar CSV com todas as liga√ß√µes filtradas
9. Migrations: tabelas `calls` e `call_feedback` com RLS
10. Registros de liga√ß√£o podem ser criados manualmente (formul√°rio)

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Migrations** (AC: 9)
  - [x] 1.1 Tabela `calls`: id, org_id, user_id, lead_id (nullable FK), origin, destination, started_at, duration_seconds, status (significant|not_significant|no_contact|busy|not_connected), type (inbound|outbound|manual), cost (numeric nullable), recording_url (text nullable), notes (text nullable), is_important (bool default false), created_at, updated_at
  - [x] 1.2 Tabela `call_feedback`: id, call_id (FK), user_id, content (text), created_at
  - [x] 1.3 RLS em ambas: `user_org_id() = org_id` (calls), join via calls para call_feedback
  - [x] 1.4 √çndices: (org_id, started_at), (org_id, user_id), (lead_id)
  - [x] 1.5 Rollbacks

- [x] **Task 2: Feature module structure** (AC: 1)
  - [x] 2.1 Criar `src/features/calls/` com structure padr√£o
  - [x] 2.2 Types: CallRow, CallFeedbackRow, CallStatus, CallType
  - [x] 2.3 Schemas: Zod para create/update/filter
  - [x] 2.4 Index barrel export

- [x] **Task 3: Server Actions** (AC: 2, 4, 8, 10)
  - [x] 3.1 `get-calls.ts` ‚Äî listar com filtros (per√≠odo, status, user, busca, favoritas)
  - [x] 3.2 `get-call-detail.ts` ‚Äî call + feedbacks
  - [x] 3.3 `create-call.ts` ‚Äî registro manual
  - [x] 3.4 `update-call-status.ts` ‚Äî classificar status
  - [x] 3.5 `add-call-feedback.ts` ‚Äî adicionar feedback
  - [x] 3.6 `export-calls-csv.ts` ‚Äî export filtrado

- [x] **Task 4: Calls List UI** (AC: 1, 2, 3, 4)
  - [x] 4.1 `CallsListView.tsx` ‚Äî page principal
  - [x] 4.2 `CallsFilters.tsx` ‚Äî barra de filtros
  - [x] 4.3 `CallStatusIcon.tsx` ‚Äî √≠cone por status
  - [x] 4.4 `CallsTable.tsx` ‚Äî tabela com colunas
  - [x] 4.5 Bot√£o exportar CSV

- [x] **Task 5: Call Detail Modal** (AC: 5, 6, 7)
  - [x] 5.1 `CallDetailModal.tsx` ‚Äî dialog com metadados
  - [x] 5.2 Player de √°udio placeholder (UI sem funcionalidade real)
  - [x] 5.3 Status dropdown para classificar
  - [x] 5.4 Se√ß√£o feedback com rich text (usar textarea ou editor simples)
  - [x] 5.5 Lista de feedbacks existentes com avatar

- [x] **Task 6: App routing** (AC: 1)
  - [x] 6.1 Criar `src/app/(app)/calls/page.tsx`
  - [x] 6.2 Integrar na navega√ß√£o sidebar (Liga√ß√µes com √≠cone Phone)

- [x] **Task 7: Testes**
  - [x] 7.1 Testes para server actions (CRUD, filtros, export) ‚Äî 27 testes
  - [x] 7.2 Testes para schemas ‚Äî 17 testes
  - [x] 7.3 Testes para CallStatusIcon component ‚Äî 16 testes
  - [x] 7.4 Testes para CallsTable component ‚Äî 7 testes

## Dev Notes

**Nova feature module completa:** Seguir padr√£o de `src/features/leads/` como refer√™ncia para a estrutura.

**Meetime Reference:** Screenshots 15, 16 ‚Äî Lista de liga√ß√µes com filtros e modal de detalhes

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/calls/**/*.test.ts`
- **Rodar:** `pnpm vitest run src/features/calls`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |
| 2026-02-21 | 1.1 | Valida√ß√£o GO (10/10) ‚Äî status Draft ‚Üí Ready | @po (Pax) |
| 2026-02-21 | 2.0 | Implementa√ß√£o completa ‚Äî migrations, actions, UI, testes (67 tests, 966 total pass) | @dev (Dex) |
| 2026-02-21 | 2.1 | Migration fixada: added BEGIN/COMMIT, ON DELETE CASCADE, update_updated_at() trigger, public.user_org_id() RLS, policy naming convention, CHECKs | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- TooltipProvider missing in component tests ‚Äî fixed by wrapping with `renderWithProvider()`
- Supabase type errors for `calls`/`call_feedback` tables not in generated types ‚Äî fixed with `'table' as never` pattern
- `getByLabelText` not finding sr-only text ‚Äî fixed with `getByRole('button', { name: /pattern/i })`

### Completion Notes List
- Migration: `calls` table with 5-value status enum, 3-value type enum, full RLS + indices
- Migration: `call_feedback` table with RLS via JOIN
- 6 server actions: get-calls, get-call-detail, create-call, update-call-status, add-call-feedback, export-calls-csv
- 5 UI components: CallsListView, CallsFilters, CallStatusIcon, CallsTable, CallDetailModal, CallsPagination
- CallDetailModal includes: audio placeholder, status dropdown, metadata grid, feedback section with avatar
- CSV export with proper field escaping and pt-BR labels
- 67 tests total for calls module (27 actions + 17 schemas + 16 CallStatusIcon + 7 CallsTable)
- Sidebar updated with "Liga√ß√µes" nav item (Phone icon, /calls route)

### File List
- `supabase/migrations/20260221001500_calls_module.sql` ‚Äî NEW
- `src/features/calls/types/index.ts` ‚Äî NEW
- `src/features/calls/schemas/call.schemas.ts` ‚Äî NEW
- `src/features/calls/schemas/call.schemas.test.ts` ‚Äî NEW
- `src/features/calls/actions/get-calls.ts` ‚Äî NEW
- `src/features/calls/actions/get-calls.test.ts` ‚Äî NEW
- `src/features/calls/actions/get-call-detail.ts` ‚Äî NEW
- `src/features/calls/actions/get-call-detail.test.ts` ‚Äî NEW
- `src/features/calls/actions/create-call.ts` ‚Äî NEW
- `src/features/calls/actions/create-call.test.ts` ‚Äî NEW
- `src/features/calls/actions/update-call-status.ts` ‚Äî NEW
- `src/features/calls/actions/update-call-status.test.ts` ‚Äî NEW
- `src/features/calls/actions/add-call-feedback.ts` ‚Äî NEW
- `src/features/calls/actions/add-call-feedback.test.ts` ‚Äî NEW
- `src/features/calls/actions/export-calls-csv.ts` ‚Äî NEW
- `src/features/calls/actions/export-calls-csv.test.ts` ‚Äî NEW
- `src/features/calls/components/CallStatusIcon.tsx` ‚Äî NEW
- `src/features/calls/components/CallStatusIcon.test.tsx` ‚Äî NEW
- `src/features/calls/components/CallsFilters.tsx` ‚Äî NEW
- `src/features/calls/components/CallsTable.tsx` ‚Äî NEW
- `src/features/calls/components/CallsTable.test.tsx` ‚Äî NEW
- `src/features/calls/components/CallsPagination.tsx` ‚Äî NEW
- `src/features/calls/components/CallsListView.tsx` ‚Äî NEW
- `src/features/calls/components/CallDetailModal.tsx` ‚Äî NEW
- `src/app/(app)/calls/page.tsx` ‚Äî NEW
- `src/shared/components/AppSidebar.tsx` ‚Äî MODIFIED (added Phone icon + Liga√ß√µes nav item)
