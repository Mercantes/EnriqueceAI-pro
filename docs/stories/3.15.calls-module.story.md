# Story 3.15: LigaÃ§Ãµes â€” Lista e Detalhes

## Status

**Draft**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**XL (8 points)** â€” Nova feature module completa com migrations, CRUD, UI complexa.

## Risks

- **R1:** MÃ³dulo de ligaÃ§Ãµes sem integraÃ§Ã£o VoIP real pode parecer incompleto
- **R2:** Player de Ã¡udio placeholder precisa de UX clara indicando "integraÃ§Ã£o futura"
- **R3:** Tabela calls com muitas colunas â€” migration precisa de review

## Story

**As a** SDR ou manager,
**I want** um mÃ³dulo de ligaÃ§Ãµes com lista filtrÃ¡vel, status por tipo e modal de detalhes com feedback,
**so that** eu possa registrar e acompanhar todas as ligaÃ§Ãµes da equipe.

## Scope

**IN:**
- Nova feature module `src/features/calls/`
- Rota `/calls` com lista de ligaÃ§Ãµes
- Filtros: perÃ­odo, status, usuÃ¡rio, busca, favoritas
- Status classificÃ¡veis por tipo
- Modal de detalhes com metadados e feedback
- Player de Ã¡udio placeholder
- Exportar CSV
- Migrations: tabelas `calls`, `call_feedback`

**OUT:**
- IntegraÃ§Ã£o VoIP real (Twilio/Vonage) â€” epic separado
- GravaÃ§Ã£o de Ã¡udio real
- Click-to-call funcional
- Power Dialer engine

## Acceptance Criteria

1. Rota `/calls` com lista de ligaÃ§Ãµes e navegaÃ§Ã£o via top bar (LigaÃ§Ãµes > Lista)
2. Filtros: busca, usuÃ¡rio, perÃ­odo (Hoje, Esta Semana, Este MÃªs, Custom range), toggle favoritas, toggle Todas/Importantes
3. Status icons por tipo: Significativa (verde â†‘), NÃ£o Significativa (cinza â†“), Sem contato (amarelo), Cliente Ocupado (laranja), NÃ£o Conectada (vermelho)
4. Tabela: Status | Origem | Destino | Data | DuraÃ§Ã£o | OpÃ§Ãµes (view icon)
5. Modal de detalhes: player de Ã¡udio placeholder, metadados (status badge, origem, destino, data, duraÃ§Ã£o, tipo, custo), anotaÃ§Ãµes
6. SeÃ§Ã£o FEEDBACK no modal: rich text editor com avatar do autor
7. Status classificÃ¡vel via dropdown no modal
8. Exportar CSV com todas as ligaÃ§Ãµes filtradas
9. Migrations: tabelas `calls` e `call_feedback` com RLS
10. Registros de ligaÃ§Ã£o podem ser criados manualmente (formulÃ¡rio)

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [ ] **Task 1: Migrations** (AC: 9)
  - [ ] 1.1 Tabela `calls`: id, org_id, user_id, lead_id (nullable FK), origin, destination, started_at, duration_seconds, status (significant|not_significant|no_contact|busy|not_connected), type (inbound|outbound|manual), cost (numeric nullable), recording_url (text nullable), notes (text nullable), is_important (bool default false), created_at, updated_at
  - [ ] 1.2 Tabela `call_feedback`: id, call_id (FK), user_id, content (text), created_at
  - [ ] 1.3 RLS em ambas: `user_org_id() = org_id` (calls), join via calls para call_feedback
  - [ ] 1.4 Ãndices: (org_id, started_at), (org_id, user_id), (lead_id)
  - [ ] 1.5 Rollbacks

- [ ] **Task 2: Feature module structure** (AC: 1)
  - [ ] 2.1 Criar `src/features/calls/` com structure padrÃ£o
  - [ ] 2.2 Types: CallRow, CallFeedbackRow, CallStatus, CallType
  - [ ] 2.3 Schemas: Zod para create/update/filter
  - [ ] 2.4 Index barrel export

- [ ] **Task 3: Server Actions** (AC: 2, 4, 8, 10)
  - [ ] 3.1 `get-calls.ts` â€” listar com filtros (perÃ­odo, status, user, busca, favoritas)
  - [ ] 3.2 `get-call-detail.ts` â€” call + feedbacks
  - [ ] 3.3 `create-call.ts` â€” registro manual
  - [ ] 3.4 `update-call-status.ts` â€” classificar status
  - [ ] 3.5 `add-call-feedback.ts` â€” adicionar feedback
  - [ ] 3.6 `export-calls-csv.ts` â€” export filtrado

- [ ] **Task 4: Calls List UI** (AC: 1, 2, 3, 4)
  - [ ] 4.1 `CallsListView.tsx` â€” page principal
  - [ ] 4.2 `CallsFilters.tsx` â€” barra de filtros
  - [ ] 4.3 `CallStatusIcon.tsx` â€” Ã­cone por status
  - [ ] 4.4 `CallsTable.tsx` â€” tabela com colunas
  - [ ] 4.5 BotÃ£o exportar CSV

- [ ] **Task 5: Call Detail Modal** (AC: 5, 6, 7)
  - [ ] 5.1 `CallDetailModal.tsx` â€” dialog com metadados
  - [ ] 5.2 Player de Ã¡udio placeholder (UI sem funcionalidade real)
  - [ ] 5.3 Status dropdown para classificar
  - [ ] 5.4 SeÃ§Ã£o feedback com rich text (usar textarea ou editor simples)
  - [ ] 5.5 Lista de feedbacks existentes com avatar

- [ ] **Task 6: App routing** (AC: 1)
  - [ ] 6.1 Criar `src/app/(app)/calls/page.tsx`
  - [ ] 6.2 Integrar na navegaÃ§Ã£o top bar (dropdown LigaÃ§Ãµes > Lista)

- [ ] **Task 7: Testes**
  - [ ] 7.1 Testes para server actions (CRUD, filtros, export)
  - [ ] 7.2 Testes para schemas
  - [ ] 7.3 Testes para CallStatusIcon component
  - [ ] 7.4 Testes para filtros

## Dev Notes

**Nova feature module completa:** Seguir padrÃ£o de `src/features/leads/` como referÃªncia para a estrutura.

**Meetime Reference:** Screenshots 15, 16 â€” Lista de ligaÃ§Ãµes com filtros e modal de detalhes

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/calls/**/*.test.ts`
- **Rodar:** `pnpm vitest run src/features/calls`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_
