# Story 2.1: Cadence Execution Engine (Edge Function)

## Status

**InProgress**

## Complexity Estimate

**XL (Extra Large)** — Edge Function com lógica de execução de cadências, envio de mensagens, rate limiting, e integração com múltiplos serviços externos.

## Risks

- **R1:** pg_cron já está agendado para chamar `/functions/v1/execute-cadence-steps` a cada 15min, mas a function não existe
- **R2:** Envio real de email/WhatsApp depende das Stories 2.2 e 2.4 — usar stubs inicialmente
- **R3:** AI personalization depende do Claude API — já implementado em `src/features/ai/`

## Story

**As a** sales team using cadences,
**I want** enrolled leads to automatically receive messages at scheduled times,
**so that** our outbound cadences execute without manual intervention.

## Acceptance Criteria

1. Edge Function `execute-cadence-steps` processando enrollments com `next_step_due <= now()`
2. Para cada enrollment due: buscar step, renderizar template com dados do lead, enviar mensagem
3. Registrar interaction no banco (type, channel, content, status)
4. Avançar enrollment para próximo step (current_step++) ou completar se último step
5. Trigger `calculate_next_step_due` calcula automaticamente o próximo `next_step_due`
6. Se step tem `ai_personalization = true`, chamar Claude API para personalizar mensagem
7. Rate limiting: máximo 50 mensagens por execução (batch size configurável)
8. Error handling: falhas não bloqueiam outros enrollments, erros logados
9. Idempotência: re-execuções não enviam mensagens duplicadas
10. Logging estruturado para debugging

## Tasks / Subtasks

- [x] **Task 1: Criar Edge Function base**
  - [x] 1.1 Criar `supabase/functions/execute-cadence-steps/index.ts`
  - [x] 1.2 Setup Supabase admin client na function (valida service_role_key)
  - [x] 1.3 Autenticação via service_role_key no header

- [x] **Task 2: Query de enrollments due**
  - [x] 2.1 SELECT enrollments WHERE status='active' AND next_step_due <= now()
  - [x] 2.2 JOIN com leads para dados completos
  - [x] 2.3 LIMIT configurável (batch size = 50)

- [x] **Task 3: Template rendering**
  - [x] 3.1 Reutilizar lógica de `render-template.ts` (variáveis do lead)
  - [x] 3.2 Se ai_personalization: chamar Claude API via existing ai.service

- [x] **Task 4: Message dispatch**
  - [x] 4.1 Interaction registrada como 'sent' (dispatch real nas Stories 2.2/2.3)
  - [x] 4.2 Stub para email (registra interaction) — real na Story 2.2
  - [x] 4.3 Stub para WhatsApp (registra interaction) — real na Story 2.3

- [x] **Task 5: Registrar interaction e avançar enrollment**
  - [x] 5.1 INSERT interaction com todos os dados
  - [x] 5.2 UPDATE enrollment: current_step++, trigger recalcula next_step_due
  - [x] 5.3 Se último step: marcar enrollment como 'completed'

- [x] **Task 6: Error handling e idempotência**
  - [x] 6.1 Try/catch por enrollment (falha individual não bloqueia batch)
  - [x] 6.2 Check: se interaction já existe para enrollment+step, skip
  - [x] 6.3 Logging estruturado (enrollment_id, step, channel, status, duration_ms)

- [ ] **Task 7: Deploy e teste**
  - [ ] 7.1 Deploy function via `supabase functions deploy`
  - [ ] 7.2 Testar invocação manual via curl
  - [ ] 7.3 Verificar pg_cron trigger funciona

## Architecture

### Hybrid Relay Pattern
```
pg_cron (every 15 min)
  → Supabase Edge Function (thin relay, validates service_role_key)
    → Next.js API route /api/cron/execute-cadence-steps (protected by CRON_SECRET)
      → executePendingStepsCron() (service role client, bypasses RLS)
```

## File List

| File | Action | Description |
|------|--------|-------------|
| `src/features/cadences/actions/execute-cadence.ts` | Modified | Refatorado: extraiu core logic, adicionou idempotência, logging, cron export |
| `src/app/api/cron/execute-cadence-steps/route.ts` | Created | API route protegida por CRON_SECRET |
| `supabase/functions/execute-cadence-steps/index.ts` | Created | Edge Function thin relay |
| `.env.example` | Modified | Adicionou CRON_SECRET e APP_URL |

## Dev Notes

### Trigger pg_cron (já existe na migration)
```sql
SELECT cron.schedule('execute-cadence-steps', '*/15 * * * *',
  $$ SELECT net.http_post(
    url := current_setting('app.supabase_url') || '/functions/v1/execute-cadence-steps',
    headers := jsonb_build_object('Authorization', 'Bearer ' || current_setting('app.service_role_key')),
    body := '{}'::jsonb
  ) $$
);
```

### Template rendering (já existe)
`src/features/cadences/utils/render-template.ts`

### AI service (já existe)
`src/features/ai/services/ai.service.ts`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.0 | Story criada para lacuna de Edge Function | Claude (Dev) |
| 2026-02-20 | 1.1 | Implementação: hybrid relay, idempotência, logging, Tasks 1-6 completas | Claude (Dev) |
