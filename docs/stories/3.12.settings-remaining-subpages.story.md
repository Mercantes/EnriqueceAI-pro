# Story 3.12: Ajustes — Campos Personalizados + Blacklist + ABM + Acesso

## Status

**Done**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**M (5 points)** — 4 subpáginas simples com CRUD + 2 migrations.

## Risks

- **R1:** Campos personalizados exigem schema dinâmico no frontend
- **R2:** ABM é conceito avançado — manter simples (toggle + config básica)

## Story

**As a** manager,
**I want** configurar campos personalizados, blacklist de emails, vendas por contas e acesso aos leads,
**so that** eu possa customizar a prospecção conforme a necessidade da equipe.

## Scope

**IN:**
- 4 subpáginas funcionais substituindo os placeholders de 3.10
- Migrations: `custom_fields`, `email_blacklist`
- CRUD para cada configuração

**OUT:**
- Aplicação dos campos personalizados no formulário de leads
- Aplicação da blacklist no envio de emails
- Engine de ABM completa

## Acceptance Criteria

1. Subpágina "Campos Personalizados": CRUD de custom fields (name, type: text/number/date/select, options para select)
2. Subpágina "Blacklist de E-mails": CRUD de domínios bloqueados (adicionar, listar, remover)
3. Subpágina "Vendas Baseadas em Contas": toggle ABM on/off + configuração de agrupamento por empresa (campo de referência)
4. Subpágina "Acesso aos Leads": seleção de modo (todos veem todos / só seus leads / por equipe)
5. Migrations: tabelas `custom_fields` e `email_blacklist` com RLS
6. Apenas managers acessam

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Migrations** (AC: 5)
  - [x] 1.1 Tabela `custom_fields`: id, org_id, field_name, field_type (text|number|date|select), options (jsonb nullable), sort_order, created_at
  - [x] 1.2 Tabela `email_blacklist`: id, org_id, domain, created_at
  - [x] 1.3 RLS em ambas tabelas
  - [x] 1.4 Rollbacks

- [x] **Task 2: Campos Personalizados** (AC: 1)
  - [x] 2.1 Page com lista de campos
  - [x] 2.2 Form: nome do campo, tipo (select), opções (se tipo = select)
  - [x] 2.3 Server actions: CRUD custom_fields

- [x] **Task 3: Blacklist** (AC: 2)
  - [x] 3.1 Page com lista de domínios
  - [x] 3.2 Input + botão adicionar
  - [x] 3.3 Botão remover por item
  - [x] 3.4 Server actions: CRUD email_blacklist

- [x] **Task 4: ABM** (AC: 3)
  - [x] 4.1 Page com toggle on/off
  - [x] 4.2 Config: campo de agrupamento (dropdown de campos do lead)
  - [x] 4.3 Salvar em `organizations` (coluna abm_enabled, abm_group_field) ou tabela separada

- [x] **Task 5: Acesso aos Leads** (AC: 4)
  - [x] 5.1 Page com radio buttons: "Todos veem todos", "Apenas seus leads", "Por equipe"
  - [x] 5.2 Salvar em `organizations` (coluna lead_visibility_mode)

- [x] **Task 6: Testes**
  - [x] 6.1 Testes para CRUD custom_fields
  - [x] 6.2 Testes para CRUD email_blacklist
  - [x] 6.3 Testes para ABM toggle
  - [x] 6.4 Testes para Acesso config

## Dev Notes

**Dependência:** Story 3.10 (skeleton + sidebar já existe).

**Nota ABM/Acesso:** Pode ser necessário adicionar colunas em `organizations` (abm_enabled, abm_group_field, lead_visibility_mode). Se preferir, criar tabela `organization_settings` separada.

**Meetime Reference:** Screenshots 12, 13

### Testing

- **Framework:** Vitest + Testing Library
- **Rodar:** `pnpm vitest run src/features/settings-prospecting`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |
| 2026-02-21 | 1.1 | Validação GO (10/10) — status Draft → Ready | @po (Pax) |
| 2026-02-21 | 1.2 | Implementação completa — 6 tasks, 43 novos testes, status Ready → Done | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- ABM/Acesso settings saved to `organizations` table via ALTER TABLE (3 new columns: abm_enabled, abm_group_field, lead_visibility_mode)
- Used `as never` cast for `.update()` on organizations since new columns not in generated types
- email_blacklist has UNIQUE(org_id, domain) constraint to prevent duplicate domains
- custom_fields uses same `from('table' as never)` cast pattern as other settings tables
- FitScoreConfig.tsx operator type narrowing fix: cast `r.operator as 'contains' | 'equals' | 'not_empty' | 'starts_with'` to satisfy `saveFitScoreRules` param type

### Completion Notes List
- Migration `20260221_000012_custom_fields_blacklist_org_settings.sql` — 2 tables + 3 org columns with RLS
- `custom-fields-crud.ts` — CRUD with sort_order, select type validation (requires options)
- `email-blacklist-crud.ts` — CRUD with domain format validation, UNIQUE constraint
- `org-settings-crud.ts` — getOrgSettings, saveAbmSettings, saveLeadVisibility
- `CustomFieldsSettings.tsx` — inline edit with type selector, conditional options input for select type
- `BlacklistSettings.tsx` — simple domain add/remove list with monospace font
- `AbmSettings.tsx` — checkbox toggle, conditional group field dropdown (5 lead fields)
- `LeadAccessSettings.tsx` — radio-style cards (all/own/team) with descriptions
- 4 placeholder pages replaced with functional components
- 43 new tests: 8 custom fields, 6 blacklist, 6 org settings, 6+6+6+5 component tests

### File List
| File | Status |
|------|--------|
| `supabase/migrations/20260221_000012_custom_fields_blacklist_org_settings.sql` | NEW |
| `src/features/settings-prospecting/actions/custom-fields-crud.ts` | NEW |
| `src/features/settings-prospecting/actions/custom-fields-crud.test.ts` | NEW |
| `src/features/settings-prospecting/actions/email-blacklist-crud.ts` | NEW |
| `src/features/settings-prospecting/actions/email-blacklist-crud.test.ts` | NEW |
| `src/features/settings-prospecting/actions/org-settings-crud.ts` | NEW |
| `src/features/settings-prospecting/actions/org-settings-crud.test.ts` | NEW |
| `src/features/settings-prospecting/components/CustomFieldsSettings.tsx` | NEW |
| `src/features/settings-prospecting/components/CustomFieldsSettings.test.tsx` | NEW |
| `src/features/settings-prospecting/components/BlacklistSettings.tsx` | NEW |
| `src/features/settings-prospecting/components/BlacklistSettings.test.tsx` | NEW |
| `src/features/settings-prospecting/components/AbmSettings.tsx` | NEW |
| `src/features/settings-prospecting/components/AbmSettings.test.tsx` | NEW |
| `src/features/settings-prospecting/components/LeadAccessSettings.tsx` | NEW |
| `src/features/settings-prospecting/components/LeadAccessSettings.test.tsx` | NEW |
| `src/app/(app)/settings/prospecting/custom-fields/page.tsx` | MODIFIED |
| `src/app/(app)/settings/prospecting/blacklist/page.tsx` | MODIFIED |
| `src/app/(app)/settings/prospecting/abm/page.tsx` | MODIFIED |
| `src/app/(app)/settings/prospecting/access/page.tsx` | MODIFIED |
| `src/features/settings-prospecting/components/FitScoreConfig.tsx` | MODIFIED (operator type fix) |
