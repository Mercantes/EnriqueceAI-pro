# Story 3.14: Leads — Lista Refatorada com Score

## Status

**Done**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**S (3 points)** — UI update na lista existente de leads.

## Risks

- **R1:** Score circle visual precisa de SVG ou CSS ring — complexidade visual
- **R2:** Ordenação por score pode conflitar com ordenação existente

## Story

**As a** SDR ou manager,
**I want** ver o Fit Score visual na lista de leads com avatar score circle e status badges,
**so that** eu possa rapidamente identificar os leads mais qualificados.

## Scope

**IN:**
- Avatar com score circle visual
- Status badges Meetime-style
- Coluna Responsável
- Menu de ações por lead
- Ordenação por score

**OUT:**
- Página de detalhe do lead (manter existente)
- Importação CSV (manter existente)
- Enriquecimento (manter existente)
- Filtro avançado por score range

## Acceptance Criteria

1. Avatar com score circle: anel colorido ao redor do avatar (verde >=7, amarelo 4-6, vermelho <=3, cinza se null)
2. Score numérico visível dentro ou ao lado do circle
3. Status badges: ATIVO (verde), ESPERANDO INICIO (cinza) — mapear de status existente
4. Coluna "Responsável" mostrando SDR atribuído (created_by ou campo futuro)
5. Menu de ações por lead (editar, arquivar, mover cadência, etc.)
6. Leads ordenáveis por fit_score (ascendente/descendente)
7. Compatível com busca e filtros existentes (sem regressão)

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Score Circle component** (AC: 1, 2)
  - [x] 1.1 Criar `src/features/leads/components/LeadScoreCircle.tsx`
  - [x] 1.2 SVG ring com cor baseada no score
  - [x] 1.3 Score numérico centralizado
  - [x] 1.4 Props: score (number | null), size

- [x] **Task 2: Status badges** (AC: 3)
  - [x] 2.1 Mapear lead.status -> Meetime labels (new->ESPERANDO INICIO, contacted/qualified->ATIVO, etc.)
  - [x] 2.2 Componente `LeadStatusBadge.tsx` — variant prop (default | meetime)

- [x] **Task 3: Atualizar lista** (AC: 4, 5, 6, 7)
  - [x] 3.1 Integrar LeadScoreCircle no avatar da tabela
  - [x] 3.2 Adicionar coluna Responsável
  - [x] 3.3 Adicionar ActionMenu por lead (editar, enriquecer, arquivar)
  - [x] 3.4 Adicionar sort by fit_score (clickable column headers)
  - [x] 3.5 Verificar que filtros/busca existentes continuam funcionando

- [x] **Task 4: Testes**
  - [x] 4.1 Testes para LeadScoreCircle (12 testes — cores por range, null state, SVG ring)
  - [x] 4.2 Testes para LeadStatusBadge (15 testes — default + meetime variants)
  - [x] 4.3 Teste de regressão: lista existente funciona (15 testes — score, sort, actions)

## Dev Notes

**Dependência:** Story 3.13 (coluna fit_score existe e é calculada).

**Score circle colors:**
- score >= 7: `text-green-500` / `stroke-green-500`
- score 4-6: `text-yellow-500` / `stroke-yellow-500`
- score <= 3: `text-red-500` / `stroke-red-500`
- null: `text-gray-300` / `stroke-gray-300`

**Meetime Reference:** Screenshot 14 — Lista de leads com avatar score circle

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/leads/**/*.test.ts`
- **Rodar:** `pnpm vitest run src/features/leads`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |
| 2026-02-21 | 1.1 | Validação GO (10/10) — status Draft → Ready | @po (Pax) |
| 2026-02-21 | 1.2 | Implementação completa — 4 tasks, 42 testes novos | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- Lint error: removed unused imports (Trash2, EnrichmentStatusBadge) from LeadTable.tsx
- Type error: added fit_score to LeadProfile.test.tsx mock lead
- Type error: added `unknown` cast in recalc-fit-scores.test.ts
- Test fix: updated fetch-leads.test.ts to expect `nullsFirst: false` in order call

### Completion Notes List
- LeadScoreCircle: SVG ring com cor verde/amarelo/vermelho/cinza baseada no score, range normalizado -20 a 20
- LeadStatusBadge: adicionado variant="meetime" com labels ESPERANDO INÍCIO, ATIVO, DESCARTADO, ARQUIVADO
- LeadTable: integrado score circle, coluna Responsável, DropdownMenu de ações (editar, enriquecer, arquivar), sort clickable em Score e Importado em
- sort_by/sort_dir propagados via URL params (page → fetch-leads → LeadTable)
- 885 testes passando, 0 erros de lint, typecheck OK (apenas erros pré-existentes .next/dev/types)

### File List
- `src/features/leads/components/LeadScoreCircle.tsx` — NEW (SVG score ring)
- `src/features/leads/components/LeadScoreCircle.test.tsx` — NEW (12 testes)
- `src/features/leads/components/LeadStatusBadge.tsx` — MODIFIED (variant meetime)
- `src/features/leads/components/LeadStatusBadge.test.tsx` — MODIFIED (15 testes, +5 meetime)
- `src/features/leads/components/LeadTable.tsx` — MODIFIED (score circle, sort, actions, responsável)
- `src/features/leads/components/LeadTable.test.tsx` — MODIFIED (15 testes, +6 novos)
- `src/features/leads/components/LeadProfile.test.tsx` — MODIFIED (added fit_score to mock)
- `src/features/leads/types/index.ts` — MODIFIED (added fit_score to LeadRow)
- `src/features/leads/schemas/lead.schemas.ts` — MODIFIED (added sort_by, sort_dir)
- `src/features/leads/actions/fetch-leads.ts` — MODIFIED (dynamic sort with nullsFirst)
- `src/features/leads/actions/fetch-leads.test.ts` — MODIFIED (updated order assertion)
- `src/features/leads/actions/recalc-fit-scores.test.ts` — MODIFIED (unknown cast fix)
- `src/app/(app)/leads/page.tsx` — MODIFIED (pass sort_by, sort_dir from URL)
