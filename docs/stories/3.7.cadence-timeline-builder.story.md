# Story 3.7: Cad√™ncia ‚Äî Timeline Builder (Drag & Drop)

## Status

**Ready for Review**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**XL (8 points)** ‚Äî Drag & drop com dnd-kit, timeline por dia, novo step type.

## Risks

- **R1:** dnd-kit pode exigir SSR handling (Next.js)
- **R2:** Numera√ß√£o autom√°tica ao reordenar √© complexa
- **R3:** Step type "research" precisa de migration no enum

## Story

**As a** manager,
**I want** um builder de cad√™ncia com timeline por dia e sidebar de atividades arrast√°veis,
**so that** eu possa montar cad√™ncias visualmente como no Meetime.

## Scope

**IN:**
- Sidebar com tipos de atividade expand√≠veis
- Drag & drop para timeline (dnd-kit)
- Numera√ß√£o autom√°tica
- √çcones e cores por tipo
- Collapsible por dia
- Tipo "Pesquisa" como novo step type
- Persist√™ncia no banco

**OUT:**
- Templates de e-mail inline
- Delay autom√°tico entre dias (config avan√ßada)
- A/B testing de steps
- Engine de automa√ß√£o de envio

## Acceptance Criteria (Given/When/Then)

```gherkin
Given que estou na tela de edi√ß√£o de uma cad√™ncia
When eu arrasto um tipo "E-mail" da sidebar para o Dia 1
Then a atividade aparece no Dia 1 com numera√ß√£o autom√°tica e √≠cone de e-mail

Given que existem 3 atividades no Dia 1
When eu arrasto a atividade 3 para o Dia 2
Then ela se move para o Dia 2 e a numera√ß√£o √© recalculada em ambos dias

Given que estou visualizando o timeline
When eu clico no header "Dia 2"
Then o conte√∫do do Dia 2 colapsa/expande

Given que eu adicionei atividades e clico "Editar Cad√™ncia" (salvar)
Then as altera√ß√µes s√£o salvas no banco com step_order correto por dia

Given que o tipo "Pesquisa" n√£o existia
When eu expando "+ Pesquisa" na sidebar
Then posso arrastar um step de pesquisa para a timeline
```

Additional:
- [x] Migration: tipo `research` no enum de `cadence_steps.channel`
- [x] Bottom bar com nome da cad√™ncia, Voltar e "Editar Cad√™ncia" (salvar)

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Migration ‚Äî step type research** (AC: research type)
  - [x] 1.1 Migration: ADD 'phone', 'linkedin', 'research' to channel_type enum
  - [x] 1.2 Atualizar types TypeScript para incluir novos channel types

- [x] **Task 2: Instalar dnd-kit** (prerequisite)
  - [x] 2.1 `pnpm add @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities`
  - [x] 2.2 Verificar compatibilidade com React 19

- [x] **Task 3: Sidebar de atividades** (AC: sidebar + pesquisa)
  - [x] 3.1 Componente `ActivityTypeSidebar.tsx`
  - [x] 3.2 Categorias expand√≠veis: E-mail, Liga√ß√£o, Social Point, Pesquisa
  - [x] 3.3 Items arrast√°veis (DragOverlay)

- [x] **Task 4: Timeline por dia** (AC: drag, numera√ß√£o, collapse)
  - [x] 4.1 Componente `CadenceTimeline.tsx`
  - [x] 4.2 Day containers como drop zones
  - [x] 4.3 Numera√ß√£o autom√°tica global (across days)
  - [x] 4.4 Collapsible por dia (Accordion/Collapsible)
  - [x] 4.5 √çcones e cores por tipo (email=azul, liga√ß√£o=verde, social=roxo, pesquisa=laranja)

- [x] **Task 5: Drag & Drop logic** (AC: drag between days)
  - [x] 5.1 DndContext com sensors
  - [x] 5.2 SortableContext per day
  - [x] 5.3 Cross-container drag (move between days)
  - [x] 5.4 Recalc numera√ß√£o on drop

- [x] **Task 6: Bottom bar + Salvar** (AC: salvar)
  - [x] 6.1 Componente BottomBar com nome cad√™ncia, Voltar, "Editar Cad√™ncia"
  - [x] 6.2 Server action para salvar steps (upsert cadence_steps)
  - [x] 6.3 Mapear dias/posi√ß√µes para delay_days e step_order

- [x] **Task 7: Testes**
  - [x] 7.1 Testes para numera√ß√£o autom√°tica (add, remove, reorder)
  - [x] 7.2 Testes para save action (step_order correto)
  - [x] 7.3 Testes para sidebar (render categorias)

## Dev Notes

**Source Tree:**
```
src/features/cadences/components/    ‚Üí Novos componentes de builder
src/features/cadences/actions/       ‚Üí Update save cadence steps
src/features/cadences/types/         ‚Üí Adicionar 'research' ao channel type
```

**CadenceStep atual:** id, cadence_id, step_order, channel (email|whatsapp|phone|linkedin), template_id, delay_days, delay_hours, ai_personalization, created_at

**Mapeamento dia/step:** delay_days determina o dia. Dia 1 = delay_days: 0, Dia 2 = delay_days: 1, etc. step_order √© a posi√ß√£o dentro do dia.

**Meetime Reference:** Screenshot 5 ‚Äî Sidebar esquerda com categorias, timeline por dia √† direita

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/cadences/**/*.test.ts`
- **Nota:** dnd-kit precisa de mock para DndContext em testes
- **Rodar:** `pnpm vitest run src/features/cadences`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |
| 2026-02-21 | 1.1 | Implementation complete ‚Äî all tasks done | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- ChannelType expansion required updating channelIcon/channelLabel Records in 4 files (LeadTimeline, ActivityLeadContext, TemplateListView, CadenceBuilder)
- ActivityExecutionSheetContent needed type narrowing for new channel types (phone/linkedin/research not yet handled for execution)

### Completion Notes List
- Migration adds 'phone', 'linkedin', 'research' to channel_type PostgreSQL enum
- ChannelType expanded: 'email' | 'whatsapp' | 'phone' | 'linkedin' | 'research'
- channelTypeSchema updated in cadence.schemas.ts
- @dnd-kit/core@6.3.1, @dnd-kit/sortable@10.0.0, @dnd-kit/utilities@3.2.2 installed
- ActivityTypeSidebar: 4 expandable categories (E-mail, Liga√ß√£o, Social Point, Pesquisa) with draggable items
- CadenceTimeline: Day containers with SortableContext, global auto-numbering, collapsible days, color-coded icons
- Cross-container drag between days via DragOver handler
- TimelineBuilder: Integrates sidebar + timeline + bottom bar with save
- saveTimelineSteps server action: deletes existing steps, inserts new with delay_days/step_order mapping
- CadenceBuilder updated: new channel icons/labels, "Timeline Builder" button for editable cadences
- Page supports ?view=timeline query param to switch between CadenceBuilder and TimelineBuilder
- 18 new tests: 5 ActivityTypeSidebar + 8 CadenceTimeline (getGlobalStepNumber) + 5 saveTimelineSteps
- All 726 tests passing, 0 lint errors, typecheck clean

### File List
- `supabase/migrations/20260221_000008_channel_type_research.sql` ‚Äî NEW
- `src/features/cadences/types/index.ts` ‚Äî MODIFIED (ChannelType expanded)
- `src/features/cadences/cadence.schemas.ts` ‚Äî MODIFIED (channelTypeSchema expanded)
- `src/features/cadences/components/ActivityTypeSidebar.tsx` ‚Äî NEW
- `src/features/cadences/components/ActivityTypeSidebar.test.tsx` ‚Äî NEW
- `src/features/cadences/components/CadenceTimeline.tsx` ‚Äî NEW
- `src/features/cadences/components/CadenceTimeline.test.tsx` ‚Äî NEW
- `src/features/cadences/components/TimelineBuilder.tsx` ‚Äî NEW
- `src/features/cadences/actions/save-timeline-steps.ts` ‚Äî NEW
- `src/features/cadences/actions/save-timeline-steps.test.ts` ‚Äî NEW
- `src/features/cadences/components/CadenceBuilder.tsx` ‚Äî MODIFIED (new channel icons, Timeline Builder button)
- `src/features/cadences/components/LeadTimeline.tsx` ‚Äî MODIFIED (new channel icons/labels)
- `src/features/activities/components/ActivityLeadContext.tsx` ‚Äî MODIFIED (new channel icons)
- `src/features/activities/components/ActivityExecutionSheetContent.tsx` ‚Äî MODIFIED (type narrowing for new channels)
- `src/features/templates/components/TemplateListView.tsx` ‚Äî MODIFIED (new channel icons/labels)
- `src/app/(app)/cadences/[id]/page.tsx` ‚Äî MODIFIED (searchParams, TimelineBuilder view)
