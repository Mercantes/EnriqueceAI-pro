# Story 3.2: Dashboard ‚Äî Layout + Filtros + KPI Vis√£o Geral

## Status

**Done**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**M (5 points)** ‚Äî Refazer layout do dashboard + migration para goals.

## Risks

- **R1:** Dashboard existente √© completamente substitu√≠do ‚Äî risco de regress√£o
- **R2:** Gr√°fico de linha precisa de lib de charts (recharts ou chart.js)
- **R3:** Queries de KPI agregadas podem ser lentas sem √≠ndices

## Story

**As a** manager,
**I want** um dashboard com KPI de oportunidades, gr√°fico de meta mensal e filtros,
**so that** eu possa acompanhar o progresso da equipe em rela√ß√£o √†s metas de vendas.

## Scope

**IN:**
- Novo layout do dashboard (substituir DashboardView atual)
- Filtros funcionais (m√™s, cad√™ncias, vendedores)
- Card KPI "Oportunidades" com gr√°fico de linha
- Indicador de % acima/abaixo do previsto
- Migration: tabelas `goals`, `goals_per_user`
- RLS policies nas novas tabelas

**OUT:**
- Ranking cards por SDR (Story 3.3)
- Insights charts (Story 3.4)
- Modal de metas (Story 3.5)
- O bot√£o "Editar metas" √© renderizado mas n√£o funcional at√© 3.5

## Acceptance Criteria

1. Filtros de m√™s, cad√™ncias e vendedores funcionais com query params
2. Card KPI: "X Oportunidades em {m√™s}" com valor real do banco
3. Card meta: "Meta de oportunidades para {m√™s}: Y"
4. Indicador: "Z% abaixo/acima do previsto at√© hoje (dia D)"
5. Gr√°fico de linha: Oportunidades acumuladas vs Meta ao longo do m√™s
6. Dados reais do banco (not mock)
7. Layout responsivo (cards stack em mobile)
8. Migration criada: tabelas `goals` e `goals_per_user` com RLS
9. Bot√£o "Editar metas" renderizado (placeholder at√© Story 3.5)

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Migration ‚Äî tabelas goals** (AC: 8)
  - [x] 1.1 Criar migration `supabase/migrations/20260221_000004_goals_tables.sql`
  - [x] 1.2 Tabela `goals`: id, org_id, month (date), opportunity_target (int), conversion_target (numeric), created_by, created_at, updated_at
  - [x] 1.3 Tabela `goals_per_user`: id, org_id, user_id, month (date), opportunity_target (int), created_at, updated_at
  - [x] 1.4 RLS policies: `user_org_id() = org_id` em ambas tabelas
  - [x] 1.5 √çndices: (org_id, month) unique em goals, (org_id, user_id, month) unique em goals_per_user
  - [x] 1.6 Criar rollback em `supabase/rollbacks/`

- [x] **Task 2: Dashboard types e services** (AC: 2, 3, 4, 6)
  - [x] 2.1 Criar/atualizar `src/features/dashboard/types/index.ts` com novos tipos
  - [x] 2.2 Criar `src/features/dashboard/services/dashboard-metrics.service.ts`
  - [x] 2.3 Query: oportunidades do m√™s (leads com status 'qualified' no per√≠odo)
  - [x] 2.4 Query: meta do m√™s da tabela goals
  - [x] 2.5 C√°lculo: % progresso vs previsto at√© o dia atual

- [x] **Task 3: Server Actions** (AC: 1, 6)
  - [x] 3.1 Criar `src/features/dashboard/actions/get-dashboard-data.ts`
  - [x] 3.2 `requireAuth()` ‚Üí Zod validation ‚Üí query ‚Üí return ActionResult
  - [x] 3.3 Aceitar filtros: month, cadenceIds, userIds

- [x] **Task 4: Dashboard UI** (AC: 1, 2, 3, 4, 5, 7, 9)
  - [x] 4.1 Refazer `src/features/dashboard/components/DashboardView.tsx`
  - [x] 4.2 Componente DashboardFilters (m√™s, cad√™ncias, vendedores)
  - [x] 4.3 Componente OpportunityKpiCard (KPI grande + meta + %)
  - [x] 4.4 Componente OpportunityChart (gr√°fico de linha, usar recharts)
  - [x] 4.5 Bot√£o "Editar metas" (placeholder onClick)
  - [x] 4.6 Slots vazios para Ranking (3.3) e Insights (3.4)

- [x] **Task 5: Testes** (AC: 6)
  - [x] 5.1 Testes para dashboard-metrics.service.ts (queries, c√°lculos)
  - [x] 5.2 Testes para get-dashboard-data action (auth, filtros)
  - [x] 5.3 Testes para componentes (DashboardView, OpportunityKpiCard, Chart)

## Dev Notes

**Source Tree relevante:**
```
src/features/dashboard/                 ‚Üí REFAZER componentes
src/features/dashboard/components/      ‚Üí DashboardView.tsx, MetricCard.tsx, etc (substituir)
src/app/(app)/dashboard/page.tsx        ‚Üí Atualizar para novo DashboardView
supabase/migrations/                    ‚Üí Nova migration
```

**Dashboard existente:**
- `DashboardView.tsx` ‚Äî atualmente mostra: Total Leads, leadsByStatus, leadsByPorte, leadsByUf, enrichmentStats, recentImports
- `MetricCard.tsx`, `EnrichmentCard.tsx`, `DistributionCard.tsx`, `RecentImports.tsx`, `PeriodFilter.tsx`
- TODOS ser√£o substitu√≠dos pelo novo layout Meetime-style

**Padr√µes a seguir:**
- Server Actions com `ActionResult<T>` para queries
- `requireAuth()` para autentica√ß√£o
- `createServerSupabaseClient()` para queries server-side
- Recharts ou similar para gr√°ficos (verificar se j√° est√° em dependencies)

**Meetime Reference:** Screenshots 1, 11 ‚Äî Dashboard hero com KPI, filtros, gr√°fico de linha

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/dashboard/**/*.test.ts`
- **Pattern:** Mock supabase com `vi.mock('@/lib/supabase/server')`
- **Rodar:** `pnpm vitest run src/features/dashboard`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |
| 2026-02-21 | 1.1 | Implementa√ß√£o completa ‚Äî migration, types, service, action, UI, testes | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- Typecheck: 0 errors
- Lint: 0 errors, 0 warnings
- Tests: 619 passed, 0 failed (68 test files)
- Dashboard tests: 33 passed (4 test files)

### Completion Notes List
- Installed recharts 3.7.0 for line chart component
- DashboardView completely rewritten ‚Äî old props `{ metrics: DashboardMetrics }` replaced with `{ data: DashboardData; filters: DashboardFilters }`
- Old dashboard components (MetricCard, EnrichmentCard, DistributionCard, RecentImports, PeriodFilter) kept but unused by new DashboardView ‚Äî will be removed in cleanup story
- DashboardFilters uses URL searchParams for filter state (server-side rendering)
- OpportunityChart only renders actual data up to currentDay (future days show null)
- Cadence/user filtering uses two-step query: enrollment lookup ‚Üí filtered lead query
- Daily data computation uses `updated_at` as proxy for when leads became qualified

### File List
| File | Action | Description |
|------|--------|-------------|
| `supabase/migrations/20260221_000004_goals_tables.sql` | Created | Goals + goals_per_user tables with RLS |
| `supabase/rollbacks/20260221_000004_goals_tables_rollback.sql` | Created | Rollback for goals migration |
| `src/features/dashboard/types/index.ts` | Created | DashboardFilters, OpportunityKpiData, DailyDataPoint, CadenceOption, DashboardData |
| `src/features/dashboard/services/dashboard-metrics.service.ts` | Created | fetchOpportunityKpi, fetchAvailableCadences |
| `src/features/dashboard/actions/get-dashboard-data.ts` | Created | Server action: getDashboardData with Zod validation |
| `src/features/dashboard/components/DashboardView.tsx` | Modified | Rewritten with new props (data + filters) |
| `src/features/dashboard/components/DashboardFilters.tsx` | Created | Month, cadence, user filter dropdowns |
| `src/features/dashboard/components/OpportunityKpiCard.tsx` | Created | KPI card with target and % indicator |
| `src/features/dashboard/components/OpportunityChart.tsx` | Created | Recharts line chart (actual vs target) |
| `src/features/dashboard/index.ts` | Modified | Updated barrel exports with new types and components |
| `src/app/(app)/dashboard/page.tsx` | Modified | Updated to use getDashboardData with filter parsing |
| `src/features/dashboard/components/DashboardView.test.tsx` | Modified | Rewritten for new DashboardView interface (12 tests) |
| `src/features/dashboard/services/dashboard-metrics.service.test.ts` | Created | Service tests (11 tests) |
| `src/features/dashboard/actions/get-dashboard-data.test.ts` | Created | Action tests (7 tests) |
