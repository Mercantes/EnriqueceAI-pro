# Story 2.2: Gmail Email Integration

## Status

**Ready**

## Complexity Estimate

**L (Large)** — OAuth2 per-user com token refresh, envio via Gmail API, tracking de opens/clicks.

## Risks

- **R1:** OAuth2 tokens expiram a cada hora — refresh automático necessário
- **R2:** Gmail API tem quota de 250 units/sec — rate limiting necessário
- **R3:** Tracking de opens/clicks requer pixel e redirect proxy

## Story

**As a** sales team member,
**I want** cadence emails to be sent from my Gmail account,
**so that** prospects receive messages diretamente do meu email profissional.

## Acceptance Criteria

1. Conexão Gmail via OAuth2 (per-user) com consent screen
2. Tokens armazenados criptografados em `gmail_connections`
3. Refresh automático de tokens expirados
4. Envio de emails HTML via Gmail API (`messages.send`)
5. Tracking de opens via pixel invisível (API route de tracking)
6. Tracking de clicks via redirect de links (API route de redirect)
7. Registro de interaction com message_id do Gmail
8. Reply detection via Gmail API (polling ou push notification)
9. Bounce handling — marcar enrollment como 'bounced'
10. Testes unitários para o Gmail service

## Tasks / Subtasks

- [x] **Task 1: Gmail OAuth2 flow**
  - [x] 1.1 Configurar Google Cloud Console (OAuth credentials, scopes)
  - [x] 1.2 Implementar connect flow em `/api/auth/callback/gmail`
  - [x] 1.3 Armazenar tokens em `gmail_connections` (já existe tabela)
  - [x] 1.4 Token refresh automático antes de cada envio

- [x] **Task 2: Gmail Send Service**
  - [x] 2.1 Criar `src/features/integrations/services/email.service.ts`
  - [x] 2.2 Método `sendEmail({ userId, orgId, params, interactionId, supabaseClient })`
  - [x] 2.3 Construir MIME message (base64url encoded)
  - [x] 2.4 Injetar tracking pixel no HTML
  - [x] 2.5 Wrap links para click tracking

- [x] **Task 3: Tracking endpoints**
  - [x] 3.1 Criar `src/app/api/track/open/[interactionId]/route.ts` — pixel 1x1 transparent
  - [x] 3.2 Criar `src/app/api/track/click/[interactionId]/route.ts` — redirect com logging
  - [x] 3.3 Atualizar interaction com open_count/click data

- [x] **Task 4: Integrar com cadence execution**
  - [x] 4.1 Integrar EmailService.sendEmail no cadence engine
  - [x] 4.2 Buscar `cadences.created_by` para saber qual user's Gmail usar

- [x] **Task 5: Testes**
  - [x] 5.1 Testes unitários para Gmail service (mock Google API) — 7 testes passando
  - [ ] 5.2 Testes para tracking endpoints (diferido — endpoints são simples)

## Dev Notes

### Tabela gmail_connections (já existe)
```sql
CREATE TABLE gmail_connections (
  id UUID, org_id UUID, user_id UUID,
  access_token_encrypted TEXT, refresh_token_encrypted TEXT,
  token_expires_at TIMESTAMPTZ, email_address TEXT,
  status connection_status, created_at, updated_at
);
```

### OAuth callback (já existe)
`src/app/api/auth/callback/gmail/route.ts`

### Email service (já existe, precisa completar)
`src/features/integrations/services/email.service.ts`

## File List

| File | Action | Description |
|------|--------|-------------|
| `src/features/cadences/actions/execute-cadence.ts` | Modified | Bug fix: `subject` → `metadata.subject`; integrated EmailService.sendEmail for email channel |
| `src/features/integrations/services/email.service.ts` | Modified | Added `supabaseClient` param, auto-refresh token, moved env reads into function |
| `src/features/integrations/services/email.service.test.ts` | Modified | Added tests for auto-refresh, injected client, updated mock strategy |
| `src/app/api/track/open/[interactionId]/route.ts` | Created | Open tracking pixel endpoint (1x1 GIF) |
| `src/app/api/track/click/[interactionId]/route.ts` | Created | Click tracking redirect endpoint (302) |
| `.env.example` | Modified | Added GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, GOOGLE_REDIRECT_URI |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.0 | Story criada — Gmail como único provedor de email | Claude (Dev) |
| 2026-02-20 | 1.1 | Implementação: OAuth flow, send service com auto-refresh, tracking endpoints, cadence integration. Reply detection (AC8) e bounce handling (AC9) diferidos. | Claude (Dev) |
