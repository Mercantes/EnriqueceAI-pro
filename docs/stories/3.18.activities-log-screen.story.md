# Story 3.18: Atividades — Tela de Log/Histórico Separada da Execução

## Status

**Ready for Review**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**S (3 points)** — Nova tela reutilizando componentes existentes.

## Risks

- **R1:** Confusão entre "Execução" e "Atividades" no sidebar — naming claro resolve
- **R2:** Query de atividades completas + pendentes pode ser pesada — paginação resolve

## Story

**As a** SDR ou manager,
**I want** ver uma lista completa de todas as atividades (pendentes e completadas) separada da tela de execução,
**so that** eu tenha uma visão gerencial de todas as atividades sem a UI otimizada para execução.

## Scope

**IN:**
- Nova tela "Atividades" em `/activities` — log de todas as atividades
- Renomear sidebar "Atividades" → "Execução" (mantém `/atividades`)
- Novo item sidebar "Atividades" → `/activities`
- Filtros: Status, Atividade (canal), Cadência, Passo, busca
- Tabela: Atividade, Cadência, Lead (com score circle), botão Executar
- Header com contagem e "Limpar filtros"
- Barra de feedback na base quando atividade é completada

**OUT:**
- Power Dialer (manter na Execução)
- Progress cards (exclusivo da Execução)
- Pending calls section (exclusivo da Execução)
- Quick mode toggle (exclusivo da Execução)

## Acceptance Criteria

1. Sidebar mostra "Execução" (ícone Play) e "Atividades" (ícone ListChecks) como itens separados
2. Tela Atividades em `/activities` mostra todas as atividades (pendentes + completadas recentes)
3. Filtros: Status, Canal, Cadência, Passo, busca por nome/email/telefone
4. Tabela com colunas: Tempo overdue, Atividade (tipo+nome), Cadência+Passo, Lead (score circle+nome), Executar
5. Header mostra contagem total e link "Limpar filtros"
6. Compatível com componentes existentes (ActivityRow reutilizado ou adaptado)
7. Sem regressão na tela de Execução existente

## Tasks / Subtasks

- [x] **Task 1: Sidebar split** (AC: 1)
  - [x] 1.1 Renomear "Atividades" → "Execução" com ícone Play no sidebar
  - [x] 1.2 Adicionar "Atividades" com ícone ListChecks apontando para `/activities`

- [x] **Task 2: Server action** (AC: 2)
  - [x] 2.1 Criar `fetch-activity-log.ts` — query all enrollments (sem filtro de next_step_due)

- [x] **Task 3: Activity Log View** (AC: 3, 4, 5, 6)
  - [x] 3.1 Criar rota `/activities/page.tsx`
  - [x] 3.2 Criar `ActivityLogView.tsx` com header, filtros e tabela
  - [x] 3.3 Reutilizar ActivityRow para a tabela
  - [x] 3.4 Filtros via URL search params (status, channel, search) + client-side (cadence, step)

- [x] **Task 4: Testes**
  - [x] 4.1 Testes para fetch-activity-log (4 testes)
  - [x] 4.2 Testes para ActivityLogView (10 testes)
  - [x] 4.3 Regressão: 899 testes passando, 0 falhas

## Dev Notes

**Referência Meetime:** Screenshot "Atividades" — tela de log sem features de execução.

**Diferenças chave Execução vs Atividades:**
| Feature | Execução | Atividades |
|---------|----------|-----------|
| Progress cards | ✅ | ❌ |
| Pending calls | ✅ | ❌ |
| Quick mode | ✅ | ❌ |
| Tabs (Execução/Dialer) | ✅ | ❌ |
| Atividades completadas | ❌ | ✅ |
| Date range broad | ❌ | ✅ |

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/activities/**/*.test.ts`
- **Rodar:** `pnpm vitest run src/features/activities`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir de feedback visual Meetime | @dev (Dex) |
| 2026-02-21 | 1.1 | Validação rápida — status Draft → Ready | @dev (Dex) |
| 2026-02-21 | 1.2 | Implementação completa — 4 tasks, 14 testes novos | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- Fixed chain mock: removed duplicate Symbol.toStringTag assignment (defineProperty already sets it read-only)

### Completion Notes List
- Sidebar split: "Execução" (Play icon, /atividades) + "Atividades" (ListChecks icon, /activities)
- fetch-activity-log.ts: same query pattern as fetch-pending-activities but WITHOUT `.lte('next_step_due', ...)` — shows ALL active enrollments
- ActivityLogView.tsx: header com contagem + "Limpar filtros", 5 filtros (status, channel, cadência, passo, search), tabela com ActivityRow reutilizado, ActivityExecutionSheet para execução inline
- Sem progress cards, pending calls, tabs ou quick mode (exclusivos da Execução)
- 899 testes passando, 0 erros de lint, typecheck OK

### File List
- `src/shared/components/AppSidebar.tsx` — MODIFIED (added Play icon, split Execução/Atividades)
- `src/features/activities/actions/fetch-activity-log.ts` — NEW (server action for all activities)
- `src/features/activities/actions/fetch-activity-log.test.ts` — NEW (4 testes)
- `src/features/activities/components/ActivityLogView.tsx` — NEW (log view component)
- `src/features/activities/components/ActivityLogView.test.tsx` — NEW (10 testes)
- `src/app/(app)/activities/page.tsx` — NEW (route page)
- `docs/stories/3.18.activities-log-screen.story.md` — NEW (story file)
