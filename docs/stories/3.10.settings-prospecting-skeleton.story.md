# Story 3.10: Ajustes de Prospecção — Skeleton + Atividades Diárias + Motivos de Perda

## Status

**Done**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**M (5 points)** — Nova feature module com layout sidebar + 2 subpáginas CRUD.

## Risks

- **R1:** Nova rota settings/prospecting precisa conviver com settings existente
- **R2:** loss_reasons precisa de seed data para ser útil imediatamente

## Story

**As a** manager,
**I want** uma tela de ajustes de prospecção com configuração de atividades diárias e motivos de perda,
**so that** eu possa customizar as metas e opções da equipe de vendas.

## Scope

**IN:**
- Rota `/settings/prospecting` com sidebar menu de 7 itens
- Subpágina "Atividades Diárias" funcional
- Subpágina "Motivos de Perda" com CRUD
- Migration: tabela `loss_reasons`
- Apenas managers (`requireManager()`)
- Placeholders para subpáginas 3-7

**OUT:**
- Fit Score config (Story 3.11)
- Campos Personalizados, Blacklist, ABM, Acesso (Story 3.12)
- Engine de Fit Score (Story 3.13)

## Acceptance Criteria

1. Rota `/settings/prospecting` renderiza layout com sidebar menu
2. Sidebar com 7 items: Atividades Diárias, Motivos de Perda, Vendas Baseadas em Contas, Acesso aos Leads, Campos Personalizados, Blacklist de E-mails, Fit Score
3. Subpágina "Atividades Diárias": input padrão org + tabela de vendedores com input individual. Salva em `daily_activity_goals`
4. Subpágina "Motivos de Perda": listar, adicionar, editar nome, remover. Tabela `loss_reasons`
5. Motivos seed: "Sem interesse", "Sem budget", "Timing ruim", "Concorrente escolhido", "Sem resposta", "Outros"
6. Apenas managers podem acessar
7. Placeholders "Em breve" para subpáginas não implementadas
8. Migration: tabela `loss_reasons` com RLS e seed data

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Migration** (AC: 8)
  - [x] 1.1 Tabela `loss_reasons`: id, org_id, name, is_default (bool), sort_order, created_at
  - [x] 1.2 RLS: `user_org_id() = org_id`
  - [x] 1.3 Seed data: 6 motivos padrão (is_default = true)
  - [x] 1.4 Rollback

- [x] **Task 2: Feature module structure** (AC: 1, 2)
  - [x] 2.1 Criar `src/features/settings-prospecting/` ou usar `src/app/(app)/settings/prospecting/`
  - [x] 2.2 Layout com sidebar de navegação
  - [x] 2.3 Subrotas: `/settings/prospecting/daily-goals`, `/settings/prospecting/loss-reasons`, etc.

- [x] **Task 3: Atividades Diárias** (AC: 3)
  - [x] 3.1 Page component com input padrão org
  - [x] 3.2 Tabela de vendedores da org (from org_members) com input individual
  - [x] 3.3 Server action: save daily goals (upsert daily_activity_goals)
  - [x] 3.4 Server action: get daily goals

- [x] **Task 4: Motivos de Perda** (AC: 4, 5)
  - [x] 4.1 Page component com lista de motivos
  - [x] 4.2 Adicionar motivo (input + botão)
  - [x] 4.3 Editar nome (inline edit)
  - [x] 4.4 Remover motivo (com confirmação, não permite remover is_default)
  - [x] 4.5 Server actions: CRUD loss_reasons

- [x] **Task 5: Auth guard** (AC: 6)
  - [x] 5.1 `requireManager()` no layout ou em cada page
  - [x] 5.2 Redirect para dashboard se não é manager

- [x] **Task 6: Placeholders** (AC: 7)
  - [x] 6.1 Pages placeholder para: Vendas Baseadas em Contas, Acesso, Campos Personalizados, Blacklist, Fit Score
  - [x] 6.2 Banner "Em breve" com ícone

- [x] **Task 7: Testes**
  - [x] 7.1 Testes para CRUD loss_reasons actions
  - [x] 7.2 Testes para save/get daily goals actions
  - [x] 7.3 Testes para auth guard

## Dev Notes

**Settings existente:** O Flux já tem `/settings` com subpáginas: profile, users, integrations, billing. A nova rota `/settings/prospecting` é uma adição, não substitui.

**Meetime Reference:** Screenshots 12, 13 — Tela de ajustes com sidebar e subpáginas

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/settings-prospecting/**/*.test.ts` ou colocado
- **Rodar:** `pnpm vitest run src/features/settings-prospecting`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |
| 2026-02-21 | 1.1 | Validação GO (10/10) — status Draft → Ready | @po (Pax) |
| 2026-02-21 | 1.2 | Implementação completa — 7 tasks, 19 novos testes, status Ready → Done | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- `loss_reasons` table already existed (migration 000006) with `is_system` column instead of `is_default` — reused existing table, added `sort_order` column via new migration
- Supabase generated types don't include `loss_reasons` or `daily_activity_goals` — used `from('table' as never) as ReturnType<typeof supabase.from>` cast pattern
- vi.mock hoisting issue: `mockUser` variable referenced inside factory — fixed by inlining values directly in mock factory
- Chain mock `.eq()` returning plain object instead of chain for delete test — fixed by creating separate deleteChain mock

### Completion Notes List
- Migration `20260221_000010_loss_reasons_seed.sql` — adds `sort_order` column to existing `loss_reasons` table
- Prospecting settings layout with sidebar (7 items) — client component with `usePathname` for active state
- `/settings/prospecting` redirects to `/settings/prospecting/daily-goals`
- `DailyGoalsSettings` — org default input + members table with individual targets, uses admin API for user emails
- `LossReasonsSettings` — full CRUD with inline edit, system reasons protected from deletion, auto-seeds 6 defaults on first visit
- `ComingSoonPlaceholder` — reusable placeholder with Clock icon and "Em breve" message
- 5 placeholder pages: ABM, Access, Custom Fields, Blacklist, Fit Score
- Link "Prospecção" added to main `/settings` page hub
- `requireManager()` on every server page (not layout, since layout is client component)
- 19 new tests: 11 loss-reasons CRUD, 4 save-daily-goals, 4 get-daily-goals

### File List
| File | Status |
|------|--------|
| `supabase/migrations/20260221_000010_loss_reasons_seed.sql` | NEW |
| `src/app/(app)/settings/prospecting/layout.tsx` | NEW |
| `src/app/(app)/settings/prospecting/page.tsx` | NEW |
| `src/app/(app)/settings/prospecting/daily-goals/page.tsx` | NEW |
| `src/app/(app)/settings/prospecting/loss-reasons/page.tsx` | NEW |
| `src/app/(app)/settings/prospecting/abm/page.tsx` | NEW |
| `src/app/(app)/settings/prospecting/access/page.tsx` | NEW |
| `src/app/(app)/settings/prospecting/custom-fields/page.tsx` | NEW |
| `src/app/(app)/settings/prospecting/blacklist/page.tsx` | NEW |
| `src/app/(app)/settings/prospecting/fit-score/page.tsx` | NEW |
| `src/app/(app)/settings/page.tsx` | MODIFIED (added Prospecção link) |
| `src/features/settings-prospecting/actions/get-daily-goals.ts` | NEW |
| `src/features/settings-prospecting/actions/save-daily-goals.ts` | NEW |
| `src/features/settings-prospecting/actions/loss-reasons-crud.ts` | NEW |
| `src/features/settings-prospecting/components/DailyGoalsSettings.tsx` | NEW |
| `src/features/settings-prospecting/components/LossReasonsSettings.tsx` | NEW |
| `src/features/settings-prospecting/components/ComingSoonPlaceholder.tsx` | NEW |
| `src/features/settings-prospecting/actions/loss-reasons-crud.test.ts` | NEW |
| `src/features/settings-prospecting/actions/save-daily-goals.test.ts` | NEW |
| `src/features/settings-prospecting/actions/get-daily-goals.test.ts` | NEW |
