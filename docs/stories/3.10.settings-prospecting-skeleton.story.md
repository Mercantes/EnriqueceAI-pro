# Story 3.10: Ajustes de Prospecção — Skeleton + Atividades Diárias + Motivos de Perda

## Status

**Draft**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**M (5 points)** — Nova feature module com layout sidebar + 2 subpáginas CRUD.

## Risks

- **R1:** Nova rota settings/prospecting precisa conviver com settings existente
- **R2:** loss_reasons precisa de seed data para ser útil imediatamente

## Story

**As a** manager,
**I want** uma tela de ajustes de prospecção com configuração de atividades diárias e motivos de perda,
**so that** eu possa customizar as metas e opções da equipe de vendas.

## Scope

**IN:**
- Rota `/settings/prospecting` com sidebar menu de 7 itens
- Subpágina "Atividades Diárias" funcional
- Subpágina "Motivos de Perda" com CRUD
- Migration: tabela `loss_reasons`
- Apenas managers (`requireManager()`)
- Placeholders para subpáginas 3-7

**OUT:**
- Fit Score config (Story 3.11)
- Campos Personalizados, Blacklist, ABM, Acesso (Story 3.12)
- Engine de Fit Score (Story 3.13)

## Acceptance Criteria

1. Rota `/settings/prospecting` renderiza layout com sidebar menu
2. Sidebar com 7 items: Atividades Diárias, Motivos de Perda, Vendas Baseadas em Contas, Acesso aos Leads, Campos Personalizados, Blacklist de E-mails, Fit Score
3. Subpágina "Atividades Diárias": input padrão org + tabela de vendedores com input individual. Salva em `daily_activity_goals`
4. Subpágina "Motivos de Perda": listar, adicionar, editar nome, remover. Tabela `loss_reasons`
5. Motivos seed: "Sem interesse", "Sem budget", "Timing ruim", "Concorrente escolhido", "Sem resposta", "Outros"
6. Apenas managers podem acessar
7. Placeholders "Em breve" para subpáginas não implementadas
8. Migration: tabela `loss_reasons` com RLS e seed data

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [ ] **Task 1: Migration** (AC: 8)
  - [ ] 1.1 Tabela `loss_reasons`: id, org_id, name, is_default (bool), sort_order, created_at
  - [ ] 1.2 RLS: `user_org_id() = org_id`
  - [ ] 1.3 Seed data: 6 motivos padrão (is_default = true)
  - [ ] 1.4 Rollback

- [ ] **Task 2: Feature module structure** (AC: 1, 2)
  - [ ] 2.1 Criar `src/features/settings-prospecting/` ou usar `src/app/(app)/settings/prospecting/`
  - [ ] 2.2 Layout com sidebar de navegação
  - [ ] 2.3 Subrotas: `/settings/prospecting/daily-goals`, `/settings/prospecting/loss-reasons`, etc.

- [ ] **Task 3: Atividades Diárias** (AC: 3)
  - [ ] 3.1 Page component com input padrão org
  - [ ] 3.2 Tabela de vendedores da org (from org_members) com input individual
  - [ ] 3.3 Server action: save daily goals (upsert daily_activity_goals)
  - [ ] 3.4 Server action: get daily goals

- [ ] **Task 4: Motivos de Perda** (AC: 4, 5)
  - [ ] 4.1 Page component com lista de motivos
  - [ ] 4.2 Adicionar motivo (input + botão)
  - [ ] 4.3 Editar nome (inline edit)
  - [ ] 4.4 Remover motivo (com confirmação, não permite remover is_default)
  - [ ] 4.5 Server actions: CRUD loss_reasons

- [ ] **Task 5: Auth guard** (AC: 6)
  - [ ] 5.1 `requireManager()` no layout ou em cada page
  - [ ] 5.2 Redirect para dashboard se não é manager

- [ ] **Task 6: Placeholders** (AC: 7)
  - [ ] 6.1 Pages placeholder para: Vendas Baseadas em Contas, Acesso, Campos Personalizados, Blacklist, Fit Score
  - [ ] 6.2 Banner "Em breve" com ícone

- [ ] **Task 7: Testes**
  - [ ] 7.1 Testes para CRUD loss_reasons actions
  - [ ] 7.2 Testes para save/get daily goals actions
  - [ ] 7.3 Testes para auth guard

## Dev Notes

**Settings existente:** O Flux já tem `/settings` com subpáginas: profile, users, integrations, billing. A nova rota `/settings/prospecting` é uma adição, não substitui.

**Meetime Reference:** Screenshots 12, 13 — Tela de ajustes com sidebar e subpáginas

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/settings-prospecting/**/*.test.ts` ou colocado
- **Rodar:** `pnpm vitest run src/features/settings-prospecting`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_
