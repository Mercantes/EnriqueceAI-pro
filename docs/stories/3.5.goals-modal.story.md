# Story 3.5: Modal de Metas Mensais

## Status

**Done**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**S (3 points)** â€” Modal com form + cÃ¡lculo de estimativa.

## Risks

- **R1:** CÃ¡lculo automÃ¡tico de estimativa de esforÃ§o pode ser impreciso
- **R2:** ConcorrÃªncia se dois managers editam metas ao mesmo tempo

## Story

**As a** manager,
**I want** um modal para editar metas mensais de oportunidades e taxa de conversÃ£o por vendedor,
**so that** eu possa definir e ajustar os objetivos da equipe mensalmente.

## Scope

**IN:**
- Modal acessÃ­vel via "Editar metas" no dashboard
- Campos: meta de oportunidades, taxa de conversÃ£o
- Metas individuais por vendedor
- CÃ¡lculo automÃ¡tico de estimativa de esforÃ§o
- PersistÃªncia em `goals` e `goals_per_user`

**OUT:**
- HistÃ³rico de metas
- Metas por cadÃªncia especÃ­fica
- NotificaÃ§Ãµes quando meta Ã© atingida

## Acceptance Criteria

1. Modal abre via botÃ£o "Editar metas" no dashboard (Dialog/Sheet)
2. Campo "Meta de Oportunidades" (input numÃ©rico) editÃ¡vel
3. Campo "Meta de Taxa de ConversÃ£o" (input percentual %) editÃ¡vel
4. SeÃ§Ã£o vendedores: lista de SDRs da org com meta individual editÃ¡vel (mostra mÃªs anterior como referÃªncia)
5. Estimativa automÃ¡tica: "SerÃ¡ necessÃ¡rio finalizar X leads e realizar Y atividades diÃ¡rias por vendedor"
6. Salvar persiste em `goals` (org) e `goals_per_user` (por SDR)
7. Apenas managers podem abrir/editar (`requireManager()`)
8. Loading state e error handling

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Server Actions** (AC: 6, 7)
  - [x] 1.1 Criar `src/features/dashboard/actions/save-goals.ts`
  - [x] 1.2 `requireManager()` â†’ Zod validate â†’ upsert goals + goals_per_user
  - [x] 1.3 Criar `src/features/dashboard/actions/get-goals.ts`
  - [x] 1.4 Buscar goals do mÃªs selecionado + goals_per_user + mÃªs anterior como referÃªncia

- [x] **Task 2: Schemas** (AC: 2, 3, 4)
  - [x] 2.1 Criar `src/features/dashboard/schemas/goals.schema.ts`
  - [x] 2.2 Zod: opportunity_target (positive int), conversion_target (0-100), user_goals[]

- [x] **Task 3: Goals Modal UI** (AC: 1, 2, 3, 4, 5, 8)
  - [x] 3.1 Criar `src/features/dashboard/components/GoalsModal.tsx`
  - [x] 3.2 TÃ­tulo: "Metas {MÃªs}"
  - [x] 3.3 Input Meta de Oportunidades
  - [x] 3.4 Input Meta de Taxa de ConversÃ£o (%)
  - [x] 3.5 Lista de vendedores com input individual (mÃªs anterior + meta atual)
  - [x] 3.6 CÃ¡lculo automÃ¡tico de estimativa (baseado em histÃ³rico de conversÃ£o)
  - [x] 3.7 Loading + error states
  - [x] 3.8 Integrar no DashboardView (abrir via botÃ£o "Editar metas")

- [x] **Task 4: Testes** (AC: 6)
  - [x] 4.1 Testes para save-goals action (auth, validation, upsert)
  - [x] 4.2 Testes para goals schema (valid/invalid inputs)
  - [x] 4.3 Testes para GoalsModal component (render, submit)

## Dev Notes

**DependÃªncia:** Story 3.2 (tabelas goals e goals_per_user jÃ¡ existem).

**CÃ¡lculo de estimativa:**
```
leads_needed = opportunity_target / historical_conversion_rate
activities_per_day = (leads_needed * avg_activities_per_lead) / business_days_remaining / num_sdrs
```

**Meetime Reference:** Screenshot 11 â€” Modal com campos de meta e lista de vendedores

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** `src/features/dashboard/**/*.test.ts`
- **Rodar:** `pnpm vitest run src/features/dashboard`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |
| 2026-02-21 | 1.1 | Implementation complete â€” all tasks done | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- React 19 `react-hooks/set-state-in-effect` lint rule â€” eslint-disable used for fetch-on-open pattern
- Supabase `goals` / `goals_per_user` tables not in generated types â€” used `as never` cast

### Completion Notes List
- Schema validates month YYYY-MM, opportunity target >= 0, conversion 0-100, userGoals non-empty
- `get-goals` fetches org goals + per-user goals with previous month reference
- `save-goals` uses requireManager() guard + upsert with onConflict
- GoalsModal shows effort estimate: leads needed + activities/day per SDR
- DashboardView "Editar metas" button now enabled and opens GoalsModal
- 22 new tests: 9 schema, 5 save-goals action, 8 GoalsModal component

### File List
- `src/features/dashboard/schemas/goals.schema.ts` â€” NEW
- `src/features/dashboard/schemas/goals.schema.test.ts` â€” NEW
- `src/features/dashboard/actions/get-goals.ts` â€” NEW
- `src/features/dashboard/actions/save-goals.ts` â€” NEW
- `src/features/dashboard/actions/save-goals.test.ts` â€” NEW
- `src/features/dashboard/components/GoalsModal.tsx` â€” NEW
- `src/features/dashboard/components/GoalsModal.test.tsx` â€” NEW
- `src/features/dashboard/components/DashboardView.tsx` â€” MODIFIED (GoalsModal integration)
- `src/features/dashboard/components/DashboardView.test.tsx` â€” MODIFIED (GoalsModal mock, button enabled)
- `src/features/dashboard/types/index.ts` â€” MODIFIED (GoalsData, UserGoalRow)
- `src/features/dashboard/index.ts` â€” MODIFIED (barrel exports)
