# Story 1.5: Application Shell & Navigation

## Status

**Ready**

## Complexity Estimate

**L (Large)** — Muitos componentes UI (sidebar, header, breadcrumbs, skeletons, dashboard), responsividade mobile, dark mode, snapshot tests.

## Risks

- **R1:** `next-themes` pode ter conflitos com CSS variables do shadcn/ui — testar integração
- **R2:** Sidebar colapsável + drawer mobile requer testes cross-browser para UX consistente

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["typecheck", "lint", "test", "build"]

## Story

**As an** authenticated user,
**I want** to see a professional layout with clear navigation,
**so that** I can access all platform features easily.

## Acceptance Criteria

1. Layout principal com sidebar colapsável (ícones + labels)
2. Itens de navegação: Dashboard, Leads, Cadências, Templates, Integrações, Configurações
3. Header com nome do usuário, org ativa e menu dropdown (perfil, configurações, logout)
4. Layout responsivo — sidebar vira drawer em mobile
5. Breadcrumbs para navegação contextual
6. Página Dashboard com cards placeholder (métricas vazias, call-to-action para importar leads)
7. Skeleton loaders para transições de página
8. Tema visual aplicado: paleta azul/roxo, tipografia Inter, ícones Lucide
9. Dark mode toggle (opcional mas preparado no tema)
10. Testes de snapshot para componentes do shell

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [ ] **Task 1: Implementar AppSidebar** (AC: 1, 2, 4, 8)
  - [ ] 1.1 Criar `src/shared/components/AppSidebar.tsx` (`'use client'`):
    - Usar shadcn/ui `Sidebar` component (se disponível) ou implementar custom
    - Estado de colapso: `expanded` (ícone + label) e `collapsed` (ícone only)
    - Botão toggle para colapsar/expandir
    - Persistir estado de colapso em `localStorage`
  - [ ] 1.2 Definir itens de navegação:
    ```typescript
    const navItems = [
      { label: 'Dashboard', href: '/dashboard', icon: LayoutDashboard },
      { label: 'Leads', href: '/leads', icon: Users },
      { label: 'Cadências', href: '/cadences', icon: Zap },
      { label: 'Templates', href: '/templates', icon: FileText },
      { label: 'Integrações', href: '/settings/integrations', icon: Plug },
      { label: 'Configurações', href: '/settings', icon: Settings },
    ];
    ```
  - [ ] 1.3 Highlight do item ativo baseado no pathname (`usePathname()`)
  - [ ] 1.4 Logo Flux no topo da sidebar
  - [ ] 1.5 Rodapé da sidebar: versão do app ou branding
  - [ ] 1.6 Ícones Lucide React para cada item de navegação
  - [ ] 1.7 **Mobile:** sidebar vira drawer (Sheet do shadcn/ui) com overlay
    - Usar `useMediaQuery` ou Tailwind responsive classes
    - Hamburger menu no header para abrir drawer
    - Fechar drawer ao navegar

- [ ] **Task 2: Implementar AppHeader** (AC: 3, 9)
  - [ ] 2.1 Criar `src/shared/components/AppHeader.tsx` (`'use client'`):
    - Mobile: hamburger menu (toggle sidebar drawer)
    - Nome da organização ativa
    - Direita: dark mode toggle + user menu
  - [ ] 2.2 Criar `src/features/auth/components/UserMenu.tsx` (`'use client'`):
    - Avatar com iniciais do usuário (ou imagem se disponível)
    - DropdownMenu (shadcn/ui) com itens:
      - Nome + email do usuário (info, não clicável)
      - "Meu Perfil" → `/settings`
      - "Configurações" → `/settings`
      - Separator
      - "Sair" → signOut action
    - Usar `useAuth()` hook para dados do user
    - Usar `useOrganization()` hook para nome da org
  - [ ] 2.3 Implementar Dark Mode toggle:
    - Usar `next-themes` library
    - Toggle button com ícones Sun/Moon (Lucide)
    - Salvar preferência no localStorage
    - Preparar CSS variables para dark mode no `globals.css`

- [ ] **Task 3: Implementar Breadcrumbs** (AC: 5)
  - [ ] 3.1 Criar `src/shared/components/Breadcrumbs.tsx` (`'use client'`):
    - Gerar breadcrumbs automaticamente a partir do pathname
    - Map de paths para labels legíveis:
      ```typescript
      const pathLabels: Record<string, string> = {
        dashboard: 'Dashboard',
        leads: 'Leads',
        cadences: 'Cadências',
        templates: 'Templates',
        settings: 'Configurações',
        users: 'Usuários',
        integrations: 'Integrações',
        billing: 'Faturamento',
        import: 'Importar',
      };
      ```
    - Último item sem link (página atual)
    - Usar Breadcrumb component do shadcn/ui
  - [ ] 3.2 Integrar no AppHeader ou abaixo do header no layout

- [ ] **Task 4: Implementar App Layout** (AC: 1, 2, 3, 4)
  - [ ] 4.1 Atualizar `src/app/(app)/layout.tsx`:
    - Server Component que chama `requireAuth()`
    - Busca dados do user + org (para passar ao OrganizationProvider — já de Story 1.3)
    - Renderiza: `<ThemeProvider>` + `<OrganizationProvider>` + sidebar + header + main content
  - [ ] 4.2 Estrutura do layout:
    ```tsx
    <ThemeProvider attribute="class" defaultTheme="system" enableSystem>
      <OrganizationProvider {...orgProps}>
        <div className="flex h-screen">
          <AppSidebar />
          <div className="flex flex-1 flex-col overflow-hidden">
            <AppHeader />
            <main className="flex-1 overflow-auto p-6">
              <Breadcrumbs />
              <Suspense fallback={<PageSkeleton />}>
                {children}
              </Suspense>
            </main>
          </div>
        </div>
      </OrganizationProvider>
    </ThemeProvider>
    ```
  - [ ] 4.3 Instalar `next-themes` (`pnpm add next-themes`)

- [ ] **Task 5: Criar Dashboard page** (AC: 6)
  - [ ] 5.1 Criar `src/app/(app)/dashboard/page.tsx` (Server Component):
    - Chamar `requireAuth()`
    - Renderizar `<DashboardView />`
  - [ ] 5.2 Criar `src/features/dashboard/components/DashboardView.tsx` (`'use client'`):
    - Grid de 4 cards placeholder com métricas vazias:
      - "Total de Leads" — 0
      - "Cadências Ativas" — 0
      - "Emails Enviados Hoje" — 0
      - "Taxa de Resposta" — 0%
    - Usar shadcn/ui Card component
    - Ícones Lucide por card
  - [ ] 5.3 Criar `src/features/dashboard/components/EmptyDashboard.tsx`:
    - Componente de empty state quando não há dados
    - Ilustração ou ícone grande
    - "Comece importando seus leads"
    - Botão CTA "Importar Leads" → `/leads/import`
  - [ ] 5.4 Criar `src/features/dashboard/index.ts` com barrel export
  - [ ] 5.5 Criar `src/features/dashboard/dashboard.contract.ts` (placeholder)

- [ ] **Task 6: Implementar Skeleton Loaders** (AC: 7)
  - [ ] 6.1 Criar `src/shared/components/PageSkeleton.tsx`:
    - Skeleton genérico para carregamento de páginas
    - Usar Skeleton do shadcn/ui
    - Layout: header skeleton + content area com cards/table skeleton
  - [ ] 6.2 Criar `src/shared/components/TableSkeleton.tsx`:
    - Skeleton para tabelas (headers + rows animated)
  - [ ] 6.3 Criar `src/shared/components/CardSkeleton.tsx`:
    - Skeleton para cards de métricas
  - [ ] 6.4 Usar `loading.tsx` convention do Next.js:
    - Criar `src/app/(app)/dashboard/loading.tsx` → `<PageSkeleton />`
    - Criar `src/app/(app)/leads/loading.tsx` → `<TableSkeleton />`

- [ ] **Task 7: Aplicar tema visual** (AC: 8, 9)
  - [ ] 7.1 Atualizar `src/app/globals.css` com CSS variables:
    - Paleta primária: azul/roxo conforme design system
    - Paleta dark mode
    - Tipografia: Inter (body), JetBrains Mono (code)
  - [ ] 7.2 Verificar que shadcn/ui components usam as CSS variables
  - [ ] 7.3 Configurar `tailwind.config.ts` com extensões de cores se necessário
  - [ ] 7.4 Verificar dark mode toggle funciona: tema claro ↔ escuro

- [ ] **Task 8: Criar página placeholder para rotas** (AC: 2)
  - [ ] 8.1 Criar pages placeholder para rotas ainda não implementadas:
    - `src/app/(app)/leads/page.tsx` — "Leads — Em breve"
    - `src/app/(app)/cadences/page.tsx` — "Cadências — Em breve"
    - `src/app/(app)/templates/page.tsx` — "Templates — Em breve"
    - `src/app/(app)/reports/page.tsx` — "Relatórios — Em breve"
  - [ ] 8.2 Usar `<EmptyState />` component com mensagem e ícone apropriado
  - [ ] 8.3 Criar `src/shared/components/EmptyState.tsx`:
    - Props: `icon`, `title`, `description`, `action?` (button label + href)
    - Layout centralizado com ícone grande, título e descrição

- [ ] **Task 9: Testes** (AC: 10)
  - [ ] 9.1 Snapshot tests para componentes do shell:
    - `AppSidebar.test.tsx` — snapshot expanded e collapsed
    - `AppHeader.test.tsx` — snapshot com user data
    - `Breadcrumbs.test.tsx` — snapshot para diferentes paths
    - `UserMenu.test.tsx` — snapshot aberto e fechado
  - [ ] 9.2 Testes de comportamento:
    - Sidebar: toggle colapso, highlight item ativo, navegação
    - UserMenu: abrir dropdown, clicar logout
    - Breadcrumbs: gerar corretamente para nested routes
    - Dark mode: toggle muda tema
  - [ ] 9.3 Testes responsivos:
    - Mobile: sidebar renderiza como drawer
    - Desktop: sidebar renderiza inline

- [ ] **Task 10: Validação final**
  - [ ] 10.1 `pnpm lint` — sem erros
  - [ ] 10.2 `pnpm typecheck` — sem erros
  - [ ] 10.3 `pnpm test:run` — todos os testes passando
  - [ ] 10.4 `pnpm build` — build sem erros
  - [ ] 10.5 Testar visual: sidebar colapsável, header, breadcrumbs, dashboard, dark mode
  - [ ] 10.6 Testar mobile: drawer, layout responsivo
  - [ ] 10.7 Verificar que todas as rotas de navegação funcionam

## Dev Notes

### Architecture Context

**[Source: architecture.md#10-frontend-architecture]**

- Layout com sidebar + header + main content area
- Sidebar colapsável com persistência de estado
- Route groups: `(app)` para rotas protegidas com layout completo
- Server Components como padrão, Client Components apenas para interatividade

### Navigation Items

**[Source: architecture.md#10-frontend-architecture, Epic 1 AC 1.5]**

```typescript
import {
  LayoutDashboard,
  Users,
  Zap,
  FileText,
  Plug,
  Settings,
  BarChart3,
} from 'lucide-react';

interface NavItem {
  label: string;
  href: string;
  icon: LucideIcon;
  managerOnly?: boolean;
}

export const navItems: NavItem[] = [
  { label: 'Dashboard', href: '/dashboard', icon: LayoutDashboard },
  { label: 'Leads', href: '/leads', icon: Users },
  { label: 'Cadências', href: '/cadences', icon: Zap },
  { label: 'Templates', href: '/templates', icon: FileText },
  { label: 'Relatórios', href: '/reports', icon: BarChart3 },
  { label: 'Integrações', href: '/settings/integrations', icon: Plug, managerOnly: true },
  { label: 'Configurações', href: '/settings', icon: Settings },
];
```

### Route Structure

**[Source: architecture.md#12-unified-project-structure]**

```
src/app/
├── (auth)/                    # Public pages (login, signup)
│   └── layout.tsx             # Centered card layout
├── (app)/                     # Protected pages (with shell)
│   ├── dashboard/
│   │   ├── page.tsx           # Dashboard view
│   │   └── loading.tsx        # Skeleton loader
│   ├── leads/
│   │   ├── page.tsx           # Lead list (placeholder)
│   │   ├── import/page.tsx    # Import wizard (future)
│   │   └── [id]/page.tsx      # Lead profile (future)
│   ├── cadences/
│   │   ├── page.tsx           # Cadence list (placeholder)
│   │   ├── new/page.tsx       # Cadence builder (future)
│   │   └── [id]/page.tsx      # Cadence detail (future)
│   ├── templates/page.tsx     # Templates (placeholder)
│   ├── reports/page.tsx       # Reports (placeholder)
│   ├── settings/
│   │   ├── page.tsx           # Account settings (Story 1.3)
│   │   ├── users/page.tsx     # User management (Story 1.4)
│   │   ├── integrations/page.tsx  # Integrations (future)
│   │   └── billing/page.tsx   # Billing (future)
│   └── layout.tsx             # App shell: sidebar + header + providers
└── layout.tsx                 # Root layout
```

### Theme Configuration

**[Source: architecture.md#10-frontend-architecture]**

Paleta visual:
- **Primary:** Azul/Roxo gradient
- **Fonts:** Inter (body), JetBrains Mono (code blocks)
- **Icons:** Lucide React
- **Dark Mode:** Preparado via CSS variables + `next-themes`

```css
/* src/app/globals.css — Theme variables */
@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
    --primary: 221.2 83.2% 53.3%;       /* Blue */
    --primary-foreground: 210 40% 98%;
    --secondary: 263.4 70% 50.4%;        /* Purple */
    /* ... shadcn/ui default variables */
  }

  .dark {
    --background: 222.2 84% 4.9%;
    --foreground: 210 40% 98%;
    --primary: 217.2 91.2% 59.8%;
    /* ... dark mode variables */
  }
}
```

### Shared Components

**[Source: architecture.md#12-unified-project-structure]**

```
src/shared/components/
├── ui/                    # shadcn/ui components (auto-generated)
├── AppSidebar.tsx         # Main sidebar navigation
├── AppHeader.tsx          # Top header bar
├── Breadcrumbs.tsx        # Contextual navigation
├── EmptyState.tsx         # Empty state placeholder
├── PageSkeleton.tsx       # Page loading skeleton
├── TableSkeleton.tsx      # Table loading skeleton
├── CardSkeleton.tsx       # Card loading skeleton
└── DataTable.tsx          # Reusable data table (future)
```

### Layout Pattern

**[Source: architecture.md#10-frontend-architecture]**

```typescript
// src/app/(app)/layout.tsx — COMPLETE EXAMPLE
import { requireAuth } from '@/lib/auth/require-auth';
import { createServerSupabaseClient } from '@/lib/supabase/server';
import { OrganizationProvider } from '@/features/auth/components/OrganizationProvider';
import { ThemeProvider } from 'next-themes';
import { AppSidebar } from '@/shared/components/AppSidebar';
import { AppHeader } from '@/shared/components/AppHeader';

export default async function AppLayout({ children }: { children: React.ReactNode }) {
  const user = await requireAuth();
  const supabase = await createServerSupabaseClient();

  // Fetch org + member data (from Story 1.3)
  const { data: member } = await supabase
    .from('organization_members')
    .select('*, organization:organizations(*)')
    .eq('user_id', user.id)
    .eq('status', 'active')
    .single();

  const { data: members } = await supabase
    .from('organization_members')
    .select('*')
    .eq('org_id', member!.organization.id);

  return (
    <ThemeProvider attribute="class" defaultTheme="system" enableSystem>
      <OrganizationProvider
        initialOrg={member!.organization}
        initialMembers={members ?? []}
        initialMember={member!}
      >
        <div className="flex h-screen">
          <AppSidebar />
          <div className="flex flex-1 flex-col overflow-hidden">
            <AppHeader user={user} />
            <main className="flex-1 overflow-auto p-6">
              {children}
            </main>
          </div>
        </div>
      </OrganizationProvider>
    </ThemeProvider>
  );
}
```

### Dashboard Feature Structure

**[Source: architecture.md#12-unified-project-structure]**

```
src/features/dashboard/
├── components/
│   ├── DashboardView.tsx      # Main dashboard grid
│   ├── MetricCard.tsx         # Individual metric card
│   └── EmptyDashboard.tsx     # Empty state (no data yet)
├── dashboard.contract.ts      # Public API (placeholder)
└── index.ts                   # Barrel export
```

### Coding Standards

**[Source: architecture.md#17-coding-standards]**

1. **Server Components padrão:** Layout e pages são Server Components
2. **`'use client'` para interatividade:** Sidebar, header, breadcrumbs são Client Components
3. **Contract Pattern:** Dashboard expõe via `dashboard.contract.ts`
4. **Lucide Icons:** Sempre importar apenas os ícones usados (tree-shaking)
5. **Responsive:** Mobile-first com Tailwind breakpoints (`sm:`, `md:`, `lg:`)
6. **next-themes:** Para dark mode — NÃO implementar toggle manual

### Dependencies (Stories Anteriores)

- Story 1.1: Next.js, Tailwind, shadcn/ui, ícones Lucide, fontes ✅
- Story 1.2: Auth flow, requireAuth(), useAuth hook, UserMenu base ✅
- Story 1.3: OrganizationProvider, useOrganization hook ✅
- Story 1.4: Role-based access, member management UI ✅

### Testing

**[Source: architecture.md#16-testing-strategy]**

- **Snapshot Tests:** Capturar aparência visual dos componentes do shell
- **Behavior Tests:** Toggle sidebar, navegação, dropdown menu
- **Responsive Tests:** Mock de window size para testar mobile/desktop
- **Coverage target:** 60%+ para componentes

**Snapshot Test Pattern:**

```typescript
// src/shared/components/AppSidebar.test.tsx
import { render } from '@testing-library/react';
import { AppSidebar } from './AppSidebar';

// Mock next/navigation
vi.mock('next/navigation', () => ({
  usePathname: vi.fn(() => '/dashboard'),
  useRouter: vi.fn(() => ({ push: vi.fn() })),
}));

describe('AppSidebar', () => {
  it('should match expanded snapshot', () => {
    const { container } = render(<AppSidebar />);
    expect(container).toMatchSnapshot();
  });

  it('should match collapsed snapshot', () => {
    // Mock localStorage for collapsed state
    localStorage.setItem('sidebar-collapsed', 'true');
    const { container } = render(<AppSidebar />);
    expect(container).toMatchSnapshot();
  });

  it('should highlight active nav item', () => {
    const { getByText } = render(<AppSidebar />);
    const dashboardItem = getByText('Dashboard');
    expect(dashboardItem.closest('a')).toHaveClass('bg-primary/10');
  });
});
```

### Nota sobre loading.tsx

O Next.js App Router suporta `loading.tsx` convention que automaticamente mostra um fallback enquanto a page é carregada via Suspense. Criar `loading.tsx` em cada route group principal para UX de carregamento.

```typescript
// src/app/(app)/dashboard/loading.tsx
import { PageSkeleton } from '@/shared/components/PageSkeleton';

export default function DashboardLoading() {
  return <PageSkeleton />;
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-19 | 1.0 | Story criada a partir do Epic 1 | River (SM) |
| 2026-02-19 | 1.1 | Validação GO (7/10). Adicionados: Complexity Estimate, Risks. Status Draft → Ready | Pax (PO) |

## Dev Agent Record

### Agent Model Used

_(To be filled by dev agent)_

### Debug Log References

_(To be filled by dev agent)_

### Completion Notes List

_(To be filled by dev agent)_

### File List

_(To be filled by dev agent)_

## QA Results

_(To be filled by QA agent)_
