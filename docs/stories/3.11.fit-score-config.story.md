# Story 3.11: Ajustes — Fit Score Config

## Status

**Done**

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["lint", "typecheck", "test", "build"]

## Complexity Estimate

**M (5 points)** — Subpágina CRUD com regras dinâmicas + migration.

## Risks

- **R1:** Dropdown de campos deve refletir campos reais da tabela leads
- **R2:** Validação de regras complexa (operadores diferentes por tipo de campo)

## Story

**As a** manager,
**I want** configurar regras de Fit Score com pontos, campo, critério e valor,
**so that** leads sejam avaliados automaticamente pela qualidade.

## Scope

**IN:**
- Subpágina Fit Score em `/settings/prospecting`
- CRUD de regras de scoring
- Migration: tabela `fit_score_rules`
- Dropdown de campos baseado em `leads`
- Dropdown de operadores

**OUT:**
- Cálculo do score em leads (Story 3.13)
- Exibição visual do score na lista (Story 3.14)
- Regras baseadas em campos personalizados (depende de 3.12)

## Acceptance Criteria

1. Subpágina Fit Score acessível via sidebar de ajustes
2. Explicação de como funciona o Fit Score (texto estático)
3. Tabela de regras: Pontos (+/-) | Campo (dropdown) | Critério (dropdown) | Valor (input) | Delete
4. Dropdown de campos: email, telefone, cargo, porte, cnae, situacao_cadastral, razao_social, nome_fantasia, faturamento_estimado, uf, notes
5. Dropdown de operadores: Contém, É igual a, Não é vazio, Começa com
6. Adicionar regra (botão "+ Adicionar regra")
7. Remover regra (botão delete)
8. Validação: pontos obrigatório (int != 0), campo obrigatório, operador obrigatório
9. Persistência no banco
10. Migration: tabela `fit_score_rules` com RLS

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Migration** (AC: 10)
  - [x] 1.1 Tabela `fit_score_rules`: id, org_id, points (int), field (text), operator (text), value (text nullable), sort_order, created_at
  - [x] 1.2 RLS: `user_org_id() = org_id`
  - [x] 1.3 CHECK: operator IN ('contains','equals','not_empty','starts_with')
  - [x] 1.4 Rollback

- [x] **Task 2: Server Actions** (AC: 9)
  - [x] 2.1 `get-fit-score-rules.ts` — listar regras por org
  - [x] 2.2 `save-fit-score-rules.ts` — bulk upsert (receber array completo, diff e sync)
  - [x] 2.3 Zod schema para validação de regras

- [x] **Task 3: UI** (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [x] 3.1 Componente `FitScoreConfig.tsx`
  - [x] 3.2 Texto explicativo do Fit Score
  - [x] 3.3 Tabela de regras editável
  - [x] 3.4 Dropdown de campos (hardcoded de leads columns)
  - [x] 3.5 Dropdown de operadores
  - [x] 3.6 Input de pontos (number, permite negativo)
  - [x] 3.7 Input de valor (condicional — hidden se operator = 'not_empty')
  - [x] 3.8 Botão adicionar / delete por regra
  - [x] 3.9 Botão salvar todas as regras

- [x] **Task 4: Testes**
  - [x] 4.1 Testes para save-fit-score-rules action
  - [x] 4.2 Testes para Zod schema (valid/invalid rules)
  - [x] 4.3 Testes para FitScoreConfig component

## Dev Notes

**Dependência:** Story 3.10 (skeleton de ajustes já existe).

**Campos da tabela leads disponíveis:** cnpj, razao_social, nome_fantasia, email, telefone, porte, cnae, situacao_cadastral, endereco, socios, faturamento_estimado, notes. NÃO incluir: id, org_id, status, enrichment_status, timestamps.

**Meetime Reference:** Screenshot 13 — Tabela de regras de Fit Score

### Testing

- **Framework:** Vitest + Testing Library
- **Location:** Colocado na feature
- **Rodar:** `pnpm vitest run src/features/settings-prospecting`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada a partir do Epic 3 | @sm (River) |
| 2026-02-21 | 1.1 | Validação GO (10/10) — status Draft → Ready | @po (Pax) |
| 2026-02-21 | 1.2 | Implementação completa — 4 tasks, 21 novos testes, status Ready → Done | @dev (Dex) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- `fit_score_rules` table not in Supabase generated types — used `from('fit_score_rules' as never) as ReturnType<typeof supabase.from>` cast pattern
- Save strategy: delete-all + insert-all instead of diff/upsert — simpler and safer for small datasets
- Value field hidden when operator is `not_empty` — saves null to DB regardless of client value

### Completion Notes List
- Migration `20260221_000011_fit_score_rules.sql` — table with CHECK constraints on `points != 0` and valid operators, RLS with manager-only write policies
- `fit-score.schema.ts` — Zod schemas for rule validation, LEAD_FIELDS (10 fields from leads table), OPERATORS (4 types)
- `get-fit-score-rules.ts` — server action to list rules per org, ordered by sort_order
- `save-fit-score-rules.ts` — server action with Zod validation, delete-all + insert strategy, auto-nulls value for `not_empty` operator
- `FitScoreConfig.tsx` — editable rules table with Select dropdowns (shadcn/ui), inline add/remove, explanation banner, conditional value input
- Fit Score page replaced from placeholder to functional component
- 21 new tests: 9 Zod schema, 6 save action, 6 component

### File List
| File | Status |
|------|--------|
| `supabase/migrations/20260221_000011_fit_score_rules.sql` | NEW |
| `src/features/settings-prospecting/fit-score.schema.ts` | NEW |
| `src/features/settings-prospecting/fit-score.schema.test.ts` | NEW |
| `src/features/settings-prospecting/actions/get-fit-score-rules.ts` | NEW |
| `src/features/settings-prospecting/actions/save-fit-score-rules.ts` | NEW |
| `src/features/settings-prospecting/actions/save-fit-score-rules.test.ts` | NEW |
| `src/features/settings-prospecting/components/FitScoreConfig.tsx` | NEW |
| `src/features/settings-prospecting/components/FitScoreConfig.test.tsx` | NEW |
| `src/app/(app)/settings/prospecting/fit-score/page.tsx` | MODIFIED (replaced placeholder) |
